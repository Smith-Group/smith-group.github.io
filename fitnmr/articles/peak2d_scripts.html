<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Automated 2D Peak Fitting Scripts • fitnmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Automated 2D Peak Fitting Scripts">
<meta property="og:description" content="fitnmr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fitnmr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/peak2d.html">Automated 2D Peak Fitting Code</a>
    </li>
    <li>
      <a href="../articles/peak2d_scripts.html">Automated 2D Peak Fitting Scripts</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/smith-group/fitnmr/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="peak2d_scripts_files/header-attrs-2.3/header-attrs.js"></script><script src="peak2d_scripts_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Automated 2D Peak Fitting Scripts</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/smith-group/fitnmr/blob/master/vignettes/peak2d_scripts.Rmd"><code>vignettes/peak2d_scripts.Rmd</code></a></small>
      <div class="hidden name"><code>peak2d_scripts.Rmd</code></div>

    </div>

    
    
<p>FitNMR enables fully automated peak fitting of 2D NMR spectra. This document shows how the 2D fitting can be done with very little manual code entry using three convenience scripts, <code>fit_peaks_2d.R</code>, <code>refit_peaks_2d.R</code>, and <code>assign_peaks_2d.R</code>, that are included with FitNMR. For a description of how a similar workflow can be accomplished using <code>R</code> code and more details about algorithms, see the “Automated 2D Peak Fitting Code” document. The directory containing the three demo scripts that will be used here can be found by running the following from within R:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"demo"</span>, package=<span class="st">"fitnmr"</span>)
</pre></div>
<p>For each spectrum, first use NMRPipe to produce an <code>*.ft2</code> file. The data must only be apodized with the <code>SP</code> function using an exponent of 1 or 2. In addition, use the <code>EXT</code> function to extract the smallest region that contains all the relevant peaks to be fit. Eliminating noise and other extraneous peaks speeds up the processing and simplifies the output.</p>
<div id="fitting-initial-set-of-peaks" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-initial-set-of-peaks" class="anchor"></a>Fitting Initial Set of Peaks</h2>
<p>The <code>fit_peaks_2d.R</code> script handles the initial fitting of peaks. You would typically use this script to find an initial set of peaks on the highest signal-to-noise spectrum in your dataset. The script can be customized by creating a copy then editing the parameters listed at the top prior to running it in R.</p>
<p>In a typical workflow, you would create a directory to perform the initial fitting in, then copy the reference spectrum into that directory. That spectrum must have <code>.ft2</code> as the extension, otherwise the script won’t be able to find it. Ordinarily you would do this manually, but here we will do so in code. The following creates a <code>fit</code> directory and copies the first T<sub>1</sub> spectrum into it.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(<span class="st">"fit"</span>, showWarnings=<span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw">t1_dir</span>, <span class="kw">t1_ft2_filenames</span>[<span class="fl">1</span>]), <span class="st">"fit"</span>)
</pre></div>
<p>Next we need to make a copy of the <code>fit_peaks_2d.R</code> script, which may be easiest to do within R. (Note: if you want to copy the script into the current working directory, change <code>"fit"</code> to <code>"."</code> in the line below.)</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"demo"</span>, <span class="st">"fit_peaks_2d.R"</span>, package=<span class="st">"fitnmr"</span>), <span class="st">"fit"</span>)
</pre></div>
<p>You can then customize any of the options at the top of <code>fit_peaks_2d.R</code>:</p>
<pre><code># Input Files:
#  *.ft2: 2D spectra with peaks to be fit

# Output Files:
#  fit_volume.csv: peak parameters for joint fit of all *.ft2 files
#  noise_histograms.pdf: Gaussian fits of baseline intensity histograms for each *.ft2 file
#  fit_iterations.pdf: contour plots showing the result of each peak fitting iteration
#  fit_spectra.pdf: contour plots of the peaks fit to each *.ft2 file


# Fitting Parameters:

# peak height must be at least this times the noise level for a new fitting iteration
noise_cutoff &lt;- 15

# F-test p-value must be less than this value to accept the addition of a new peak
f_alpha &lt;- 0.001

# maximum number of peak fitting iterations to run
iter_max &lt;- 100

# data +/- these ppm values will be used for fitting (1H and X nuclei, respectively)
omega0_plus &lt;- c(0.075, 0.75)

# starting R2 value for the fits
r2_start &lt;- 5

# R2 values are constrained to be between these two numbers
r2_bounds &lt;- c(0.5, 20)

# starting doublet scalar coupling (1H and X nuclei, respectively), NA for singlet
sc_start &lt;- c(6, NA)

# scalar coupling values are constrained to be between these two numbers
sc_bounds &lt;- c(2, 12)


# Plotting Parameters:

# lowest contour in fit_spectra.pdf will be this number times the noise level
plot_noise_cutoff &lt;- 4

# scaling factor for fit_spectra.pdf labels
cex &lt;- 0.6</code></pre>
<p>In this case, we will use the script unmodified. The <code>fit_peaks_2d.R</code> script must be run from within the <code>fit</code> directory and the code to do this is shown below. (Note: usually you should have already set the working directory to be <code>fit</code>. If so, omit the <code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code> calls below.) As the script runs, a summary of the fitting progress will be automatically printed to the screen.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">"fit"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"fit_peaks_2d.R"</span>)
<span class="co">#&gt; Fit iteration 1:</span>
<span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 333.8 (p = 4.56642e-10)</span>
<span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 64.6 (p = 1.11899e-05)</span>
<span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 1.2 (p = 0.464419)</span>
<span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span>
<span class="co">#&gt; Fit iteration 2:</span>
<span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 734.0 (p = 1.87653e-15)</span>
<span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 14.7 (p = 0.000581712)</span>
<span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 0.1 (p = 0.976358)</span>
<span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span>
<span class="co">#&gt; Fit iteration 3:</span>
<span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 27.7 (p = 7.52698e-13)</span>
<span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 226.0 (p = 2.5923e-27)</span>
<span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 13.3 (p = 1.34241e-05)</span>
<span class="co">#&gt;  12 -&gt; 15 fit parameters: F = 68.7 (p = 1.46797e-13)</span>
<span class="co">#&gt;  15 -&gt; 18 fit parameters: F = 7.0 (p = 0.00144316)</span>
<span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span>
<span class="co">#&gt; Fit iteration 4:</span>
<span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 2022.7 (p = 1.60653e-20)</span>
<span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 14.0 (p = 0.000228688)</span>
<span class="co">#&gt;  Terminating search because fit produced zero volume</span>
<span class="co">#&gt; Fit iteration 5:</span>
<span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 107.8 (p = 9.74212e-11)</span>
<span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 260.6 (p = 2.04021e-13)</span>
<span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 11.0 (p = 0.00161564)</span>
<span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span>
<span class="co">#&gt; Fit iteration 6:</span>
<span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 1219.7 (p = 6.27674e-21)</span>
<span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 174.9 (p = 1.74543e-15)</span>
<span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 42.3 (p = 8.00775e-09)</span>
<span class="co">#&gt;  12 -&gt; 15 fit parameters: F = 11.8 (p = 0.000186865)</span>
<span class="co">#&gt;  15 -&gt; 18 fit parameters: F = 1.6 (p = 0.223018)</span>
<span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span>
<span class="co">#&gt; Fit iteration 7:</span>
<span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 232.0 (p = 1.0692e-22)</span>
<span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 15.9 (p = 1.99824e-06)</span>
<span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 54.3 (p = 1.15821e-11)</span>
<span class="co">#&gt;  Terminating search because fit produced zero volume</span>
<span class="co">#&gt; Fit iteration 8:</span>
<span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 330.9 (p = 1.75035e-07)</span>
<span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 1.8 (p = 0.274918)</span>
<span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span>
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">".."</span>)
</pre></div>
<div id="output-files" class="section level3">
<h3 class="hasAnchor">
<a href="#output-files" class="anchor"></a>Output Files</h3>
<p>Four output files are created by <code>fit_peaks_2d.R</code>:</p>
<ul>
<li><code>noise_histograms.pdf</code></li>
<li><code>fit_iterations.pdf</code></li>
<li><code>fit_spectra.pdf</code></li>
<li><code>fit_volume.csv</code></li>
</ul>
<p><code>noise_histograms.pdf</code> gives a histogram of the intensity values for each of the input spectra. The standard deviation of a Gaussian fit to that histogram is used to determine the noise level.</p>
<p><img src="fit/noise_histograms.png" width="384"></p>
<p><code>fit_iterations.pdf</code> shows each iteration of the fitting, with the data shown in black and the fit contours shown in red. Negative contours are shown with lighter colors. The starting peak position is indicated with a green circle at the highest intensity in the spectrum after previous fits have been subtracted. The blue points show the positions of the peaks in the modeled doublet.</p>
<p>The title text in parentheses gives the reason the next peak was rejected: either the p-value for the peak was greater than <code>f_alpha</code> or the peak had 0 volume. The first line of text under each peak gives the peak number and fraction of the total volume in that iteration. The second line gives the F-test p-value for that peak.</p>
<p>All peaks in a given iteration are fit with the same peak shape parameters, including the peak position (<code>omega0</code>) and doublet scalar coupling (<code>sc</code>). Those peaks are all assigned to the same fitting group (<code>fit</code>) and continue to share the same peak shape parameters in subsequent fit optimizations. This parameter sharing can be important for peaks that are highly overlapped both for accuracy and stability of the fitting algorithm. If desired, you can manually modify the peak grouping in the peak list comma separated value (CSV) file to change which peaks share parameters.</p>
<p>The first four pages of <code>fit_iterations.pdf</code> are shown here:</p>
<p><img src="fit/fit_iterations_01.png" width="326"><img src="fit/fit_iterations_02.png" width="326"><img src="fit/fit_iterations_03.png" width="326"><img src="fit/fit_iterations_04.png" width="326"></p>
<p><code>fit_spectra.pdf</code> gives the fit spectra. The doublet peak positions are shown with semi-transparent blue dots that are scaled in size such that the area is proportional to the peak volume. The first line of text under each peak gives the peak number and the fit group number separated by a colon. The second line gives the F-test p-value for that peak. By default, the lowest contour of this spectrum is set to four times the noise level, but that can be changed using the <code>plot_noise_cutoff</code> script parameter in ‘fit_peaks_2d.R’. Furthermore, the size of the labels can be controlled using the <code>cex</code> (i.e. <em>c</em>haracter <em>ex</em>pansion) script parameter.</p>
<p><img src="fit/fit_spectra.png" width="672"></p>
<p>The <code>fit_volume.csv</code> file contains all the identified peaks, the fitting group for each peak (which in this case is the iteration it was found in), the peak position/shape parameters, and a column for the volume found in each spectrum. Only one spectrum has been fit here so only one column of volumes, ‘1.ft2’, is shown.</p>
<table class="table">
<thead><tr class="header">
<th align="right">peak</th>
<th align="right">fit</th>
<th align="left">f_pvalue</th>
<th align="right">omega0_ppm_1</th>
<th align="right">omega0_ppm_2</th>
<th align="right">sc_hz_1</th>
<th align="right">r2_hz_1</th>
<th align="right">r2_hz_2</th>
<th align="right">1.ft2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="left">4.57e-10</td>
<td align="right">8.2476</td>
<td align="right">121.87</td>
<td align="right">3.2806</td>
<td align="right">2.9072</td>
<td align="right">2.33450</td>
<td align="right">824420657</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">1</td>
<td align="left">1.12e-05</td>
<td align="right">8.2596</td>
<td align="right">121.93</td>
<td align="right">3.2806</td>
<td align="right">2.9072</td>
<td align="right">2.33450</td>
<td align="right">240560662</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">2</td>
<td align="left">1.88e-15</td>
<td align="right">8.5400</td>
<td align="right">119.76</td>
<td align="right">2.0000</td>
<td align="right">4.7886</td>
<td align="right">2.09965</td>
<td align="right">1020008726</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">2</td>
<td align="left">5.82e-04</td>
<td align="right">8.5202</td>
<td align="right">119.73</td>
<td align="right">2.0000</td>
<td align="right">4.7886</td>
<td align="right">2.09965</td>
<td align="right">89977216</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">3</td>
<td align="left">7.53e-13</td>
<td align="right">8.6125</td>
<td align="right">123.36</td>
<td align="right">7.6481</td>
<td align="right">5.2849</td>
<td align="right">2.18012</td>
<td align="right">848579189</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">3</td>
<td align="left">2.59e-27</td>
<td align="right">8.5854</td>
<td align="right">123.03</td>
<td align="right">7.6481</td>
<td align="right">5.2849</td>
<td align="right">2.18012</td>
<td align="right">607904936</td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="right">3</td>
<td align="left">1.34e-05</td>
<td align="right">8.6449</td>
<td align="right">123.47</td>
<td align="right">7.6481</td>
<td align="right">5.2849</td>
<td align="right">2.18012</td>
<td align="right">147984411</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">3</td>
<td align="left">1.47e-13</td>
<td align="right">8.5370</td>
<td align="right">122.96</td>
<td align="right">7.6481</td>
<td align="right">5.2849</td>
<td align="right">2.18012</td>
<td align="right">161971930</td>
</tr>
<tr class="odd">
<td align="right">9</td>
<td align="right">4</td>
<td align="left">1.61e-20</td>
<td align="right">8.3580</td>
<td align="right">119.89</td>
<td align="right">10.2029</td>
<td align="right">2.2306</td>
<td align="right">5.03575</td>
<td align="right">875241831</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">4</td>
<td align="left">2.29e-04</td>
<td align="right">8.3791</td>
<td align="right">119.90</td>
<td align="right">10.2029</td>
<td align="right">2.2306</td>
<td align="right">5.03575</td>
<td align="right">62766713</td>
</tr>
<tr class="odd">
<td align="right">11</td>
<td align="right">5</td>
<td align="left">9.74e-11</td>
<td align="right">8.2506</td>
<td align="right">119.41</td>
<td align="right">6.3683</td>
<td align="right">4.9091</td>
<td align="right">1.85341</td>
<td align="right">732475431</td>
</tr>
<tr class="even">
<td align="right">12</td>
<td align="right">5</td>
<td align="left">2.04e-13</td>
<td align="right">8.2900</td>
<td align="right">119.38</td>
<td align="right">6.3683</td>
<td align="right">4.9091</td>
<td align="right">1.85341</td>
<td align="right">181301641</td>
</tr>
<tr class="odd">
<td align="right">13</td>
<td align="right">6</td>
<td align="left">6.28e-21</td>
<td align="right">8.4826</td>
<td align="right">122.50</td>
<td align="right">9.1982</td>
<td align="right">5.0619</td>
<td align="right">2.03464</td>
<td align="right">475854299</td>
</tr>
<tr class="even">
<td align="right">14</td>
<td align="right">6</td>
<td align="left">1.75e-15</td>
<td align="right">8.4629</td>
<td align="right">122.91</td>
<td align="right">9.1982</td>
<td align="right">5.0619</td>
<td align="right">2.03464</td>
<td align="right">28166195</td>
</tr>
<tr class="odd">
<td align="right">15</td>
<td align="right">6</td>
<td align="left">8.01e-09</td>
<td align="right">8.4768</td>
<td align="right">123.03</td>
<td align="right">9.1982</td>
<td align="right">5.0619</td>
<td align="right">2.03464</td>
<td align="right">92626742</td>
</tr>
<tr class="even">
<td align="right">16</td>
<td align="right">6</td>
<td align="left">1.87e-04</td>
<td align="right">8.4786</td>
<td align="right">122.43</td>
<td align="right">9.1982</td>
<td align="right">5.0619</td>
<td align="right">2.03464</td>
<td align="right">105607485</td>
</tr>
<tr class="odd">
<td align="right">17</td>
<td align="right">7</td>
<td align="left">1.07e-22</td>
<td align="right">8.4433</td>
<td align="right">120.73</td>
<td align="right">7.1444</td>
<td align="right">6.3350</td>
<td align="right">2.97224</td>
<td align="right">460752250</td>
</tr>
<tr class="even">
<td align="right">18</td>
<td align="right">7</td>
<td align="left">2.00e-06</td>
<td align="right">8.4252</td>
<td align="right">120.46</td>
<td align="right">7.1444</td>
<td align="right">6.3350</td>
<td align="right">2.97224</td>
<td align="right">97674580</td>
</tr>
<tr class="odd">
<td align="right">19</td>
<td align="right">7</td>
<td align="left">1.16e-11</td>
<td align="right">8.4663</td>
<td align="right">120.51</td>
<td align="right">7.1444</td>
<td align="right">6.3350</td>
<td align="right">2.97224</td>
<td align="right">62014526</td>
</tr>
<tr class="even">
<td align="right">20</td>
<td align="right">8</td>
<td align="left">1.75e-07</td>
<td align="right">8.3444</td>
<td align="right">120.76</td>
<td align="right">8.6176</td>
<td align="right">1.9530</td>
<td align="right">0.86044</td>
<td align="right">105614247</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="refining-the-initial-fit" class="section level2">
<h2 class="hasAnchor">
<a href="#refining-the-initial-fit" class="anchor"></a>Refining the Initial Fit</h2>
<p>The initial fit is done iteratively so it is usually a good idea to refine this by editing the fitting groups, deleting extraneous peaks, and then doing a simultaneous refit of all peaks together with the <code>refit_peaks_2d.R</code> script. We will do this in another directory called <code>refine</code>, to which the first spectrum and the <code>refit_peaks_2d.R</code> script should be copied:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(<span class="st">"refine"</span>, showWarnings=<span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw">t1_dir</span>, <span class="kw">t1_ft2_filenames</span>[<span class="fl">1</span>]), <span class="st">"refine"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"demo"</span>, <span class="st">"refit_peaks_2d.R"</span>, package=<span class="st">"fitnmr"</span>), <span class="st">"refine"</span>, overwrite=<span class="fl">TRUE</span>)
</pre></div>
<p>Any of the options at the top of <code>refit_peaks_2d.R</code> can then be customized:</p>
<pre><code># Input Files:
#  start_volume.csv: starting peak parameters for refitting
#  *.ft2: 2D spectra with peaks to be refit

# Output Files:
#  *_volume.csv: refit peak parameters for each *.ft2 file
#  *_fit.pdf: contour plots of the peaks fit to each *.ft2 file


# Fitting Parameters:

# data +/- these ppm values will be used for fitting (1H and X nuclei, respectively)
omega0_plus &lt;- c(0.075, 0.75)

# omega0 values are constrained to be within this factor times R2 of the starting omega0
omega0_r2_factor &lt;- 1.5

# R2 values are constrained to be between these two numbers
r2_bounds &lt;- c(0.5, 20)

# scalar coupling values are constrained to be between these two numbers
sc_bounds &lt;- c(2, 12)

# enable refitting of omega0
fit_omega0 &lt;- TRUE

# enable refitting of R2
fit_r2 &lt;- TRUE

# enable refitting of scalar couplings
fit_sc &lt;- TRUE


# Plotting Parameters:

# lowest contour in *_fit.pdf will be this number times the noise level
plot_noise_cutoff &lt;- 4

# scaling factor for *_fit.pdf labels
cex &lt;- 0.6

# show omega0 constraints imposed by omega0_r2_factor
plot_omega0_bounds &lt;- TRUE


# Computing Parameters:

# number of cores to use for refitting
mc_cores &lt;- parallel::detectCores()</code></pre>
<p>However, in this case the script will be used unmodified. The next step is to copy the peak list from the <code>fit</code> directory to a file called <code>start_volume.csv</code> in the new <code>refine</code> directory:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"fit"</span>, <span class="st">"fit_volume.csv"</span>), <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"refine"</span>, <span class="st">"start_volume.csv"</span>), overwrite=<span class="fl">TRUE</span>)
</pre></div>
<p>Once that file has been copied, you can then manually change the peak groups and delete rows for any peaks you want to discard. In this case, that will be done with the following <code>R</code> code, which puts peaks 5 and 7 into a new fitting group, and removes peaks 4, 14, and 16:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="kw">input_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"refine"</span>, <span class="st">"start_volume.csv"</span>), check.names=<span class="fl">FALSE</span>)
<span class="kw">input_table</span>[<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5</span>,<span class="fl">7</span>),<span class="st">"fit"</span>] <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">input_table</span>[,<span class="st">"fit"</span>])<span class="op">+</span><span class="fl">1</span>
<span class="kw">input_table</span> <span class="op">&lt;-</span> <span class="kw">input_table</span>[<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4</span>,<span class="fl">14</span>,<span class="fl">16</span>),]
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span>(<span class="kw">input_table</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"refine"</span>, <span class="st">"start_volume.csv"</span>), row.names=<span class="fl">FALSE</span>)
</pre></div>
<p>The final step is to call the <code>refit_peaks_2d.R</code> script from within the <code>refine</code> directory:</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">"refine"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"refit_peaks_2d.R"</span>)
<span class="co">#&gt; Fitting m0 for spectrum 1.ft2...</span>
<span class="co">#&gt; Fitting omega0,sc,r2,m0 for spectrum 1.ft2...</span>
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">".."</span>)
</pre></div>
<p>The <code>refit_peaks_2d.R</code> script first optimizes the volumes, keeping all other parameters fixed, then optimizes the volumes along with whatever other variables the user specifies in the script. Also, unlike the refinement done in “Automated 2D Peak Fitting Code”, <code>refit_peaks_2d.R</code> only fits a single spectrum at a time. This avoids two problems:</p>
<ol style="list-style-type: decimal">
<li>For many experiments in which a series of spectra are acquired, different amounts of applied power can result in subtle shifts of the temperature/peak positions. Especially for overlappling peaks, this can cause systematic variations in the volumes. Allowing each spectrum to have slightly different peak positions within a small region around the starting values helps avoid this problem.</li>
<li>When many spectra are fit simultaneously, the memory usage for FitNMR can grow very large. This will hopefully be fixed in a future update.</li>
</ol>
<div id="output-files-1" class="section level3">
<h3 class="hasAnchor">
<a href="#output-files-1" class="anchor"></a>Output Files</h3>
<p>The <code>refit_peaks_2d.R</code> script creates two files for each spectrum:</p>
<ul>
<li><code>*_fit.pdf</code></li>
<li><code>*_volume.csv</code></li>
</ul>
<p>In practice, each ’*’ will be replaced by the spectrum filename.</p>
<p><code>*_fit.pdf</code> shows the overall spectrum as described above. In addition, it also shows the constraints on the <code>omega0</code> parameters using gray rectangles, the size of which is determined by the <code>omega0_r2_factor</code> parameter. The central peak position, shown as a small blue dot, is constrained to be within that gray rectangle.</p>
<p><img src="refine/1_fit.png" width="672"></p>
<p><code>*_volume.csv</code> contains all the identified peaks, along with a column for the volume found in that spectrum.</p>
<table class="table">
<thead><tr class="header">
<th align="right">peak</th>
<th align="right">fit</th>
<th align="right">omega0_ppm_1</th>
<th align="right">omega0_ppm_2</th>
<th align="right">sc_hz_1</th>
<th align="right">r2_hz_1</th>
<th align="right">r2_hz_2</th>
<th align="right">1.ft2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">8.2476</td>
<td align="right">121.87</td>
<td align="right">3.3463</td>
<td align="right">2.8966</td>
<td align="right">2.31700</td>
<td align="right">823653059</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">1</td>
<td align="right">8.2596</td>
<td align="right">121.93</td>
<td align="right">3.3463</td>
<td align="right">2.8966</td>
<td align="right">2.31700</td>
<td align="right">239523996</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">2</td>
<td align="right">8.5395</td>
<td align="right">119.76</td>
<td align="right">2.0000</td>
<td align="right">5.6996</td>
<td align="right">2.07427</td>
<td align="right">1120612478</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">3</td>
<td align="right">8.6123</td>
<td align="right">123.37</td>
<td align="right">9.4647</td>
<td align="right">3.2950</td>
<td align="right">2.36758</td>
<td align="right">777523259</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">4</td>
<td align="right">8.5853</td>
<td align="right">123.04</td>
<td align="right">6.0587</td>
<td align="right">6.5823</td>
<td align="right">1.79531</td>
<td align="right">632568162</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">3</td>
<td align="right">8.6439</td>
<td align="right">123.45</td>
<td align="right">9.4647</td>
<td align="right">3.2950</td>
<td align="right">2.36758</td>
<td align="right">163968345</td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="right">4</td>
<td align="right">8.5370</td>
<td align="right">122.96</td>
<td align="right">6.0587</td>
<td align="right">6.5823</td>
<td align="right">1.79531</td>
<td align="right">151176240</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">5</td>
<td align="right">8.3575</td>
<td align="right">119.89</td>
<td align="right">10.1581</td>
<td align="right">1.7366</td>
<td align="right">4.73950</td>
<td align="right">803422420</td>
</tr>
<tr class="odd">
<td align="right">9</td>
<td align="right">5</td>
<td align="right">8.3749</td>
<td align="right">119.90</td>
<td align="right">10.1581</td>
<td align="right">1.7366</td>
<td align="right">4.73950</td>
<td align="right">96583110</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">6</td>
<td align="right">8.2506</td>
<td align="right">119.41</td>
<td align="right">6.0938</td>
<td align="right">5.0267</td>
<td align="right">1.77685</td>
<td align="right">731301051</td>
</tr>
<tr class="odd">
<td align="right">11</td>
<td align="right">6</td>
<td align="right">8.2901</td>
<td align="right">119.38</td>
<td align="right">6.0938</td>
<td align="right">5.0267</td>
<td align="right">1.77685</td>
<td align="right">180469307</td>
</tr>
<tr class="even">
<td align="right">12</td>
<td align="right">7</td>
<td align="right">8.4819</td>
<td align="right">122.49</td>
<td align="right">9.4013</td>
<td align="right">5.0804</td>
<td align="right">2.41291</td>
<td align="right">587357774</td>
</tr>
<tr class="odd">
<td align="right">13</td>
<td align="right">7</td>
<td align="right">8.4745</td>
<td align="right">123.01</td>
<td align="right">9.4013</td>
<td align="right">5.0804</td>
<td align="right">2.41291</td>
<td align="right">108283128</td>
</tr>
<tr class="even">
<td align="right">14</td>
<td align="right">8</td>
<td align="right">8.4433</td>
<td align="right">120.73</td>
<td align="right">9.1220</td>
<td align="right">4.8623</td>
<td align="right">3.19661</td>
<td align="right">436467804</td>
</tr>
<tr class="odd">
<td align="right">15</td>
<td align="right">8</td>
<td align="right">8.4244</td>
<td align="right">120.47</td>
<td align="right">9.1220</td>
<td align="right">4.8623</td>
<td align="right">3.19661</td>
<td align="right">95394070</td>
</tr>
<tr class="even">
<td align="right">16</td>
<td align="right">8</td>
<td align="right">8.4672</td>
<td align="right">120.52</td>
<td align="right">9.1220</td>
<td align="right">4.8623</td>
<td align="right">3.19661</td>
<td align="right">64410529</td>
</tr>
<tr class="odd">
<td align="right">17</td>
<td align="right">9</td>
<td align="right">8.3442</td>
<td align="right">120.76</td>
<td align="right">8.3984</td>
<td align="right">1.5894</td>
<td align="right">0.91155</td>
<td align="right">97879390</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="extending-the-fit-to-other-spectra" class="section level2">
<h2 class="hasAnchor">
<a href="#extending-the-fit-to-other-spectra" class="anchor"></a>Extending the Fit to Other Spectra</h2>
<p>To extend the refined fit to a series of other spectra, we will create another directory called <code>extend</code>. We will then copy both T<sub>1</sub> spectra into it. In addition, the fit parameter CSV file output from the refinement step will be copied to the file <code>start_volume.csv</code> for use as input.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(<span class="st">"extend"</span>, <span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw">t1_dir</span>, <span class="kw">t1_ft2_filenames</span>), <span class="st">"extend"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"refine"</span>, <span class="st">"1_volume.csv"</span>), <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"extend"</span>, <span class="st">"start_volume.csv"</span>), overwrite=<span class="fl">TRUE</span>)
</pre></div>
<p>We will also need to copy the <code>refit_peaks_2d.R</code> script into the <code>extend</code> directory:</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"demo"</span>, <span class="st">"refit_peaks_2d.R"</span>, package=<span class="st">"fitnmr"</span>), <span class="st">"extend"</span>, overwrite=<span class="fl">TRUE</span>)
</pre></div>
<p>However, when extending the fit to other spectra, the parameters determining the peak shape (<code>sc</code> and <code>r2</code>) will be fixed, allowing only the volume and peak position to vary. This is done by changing <code>fit_sc</code> and <code>fit_r2</code> to <code>FALSE</code> at the top of the <code>refit_peaks_2d.R</code> script, which can be done using a text editor. For the purposes of this demonstration, the two parameters are changed with the following code:</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw">script_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"extend"</span>, <span class="st">"refit_peaks_2d.R"</span>))
<span class="kw">script_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span>(<span class="st">"fit_sc &lt;- TRUE"</span>, <span class="st">"fit_sc &lt;- FALSE"</span>, <span class="kw">script_lines</span>)
<span class="kw">script_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span>(<span class="st">"fit_r2 &lt;- TRUE"</span>, <span class="st">"fit_r2 &lt;- FALSE"</span>, <span class="kw">script_lines</span>)
<span class="fu"><a href="https://rdrr.io/r/base/writeLines.html">writeLines</a></span>(<span class="kw">script_lines</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"extend"</span>, <span class="st">"refit_peaks_2d.R"</span>))
</pre></div>
<p>The part of the script controlling the parameters to be fit should now read:</p>
<pre><code># enable refitting of omega0
fit_omega0 &lt;- TRUE

# enable refitting of R2
fit_r2 &lt;- FALSE

# enable refitting of scalar couplings
fit_sc &lt;- FALSE</code></pre>
<p>Next, run <code>refit_peaks_2d.R</code> from within the <code>extend</code> directory. It will do the refitting for each spectrum on a different CPU core, reducing the total time taken to fit a large number of spectra.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">"extend"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"refit_peaks_2d.R"</span>)
<span class="co">#&gt; Fitting m0 for spectrum 1.ft2...</span>
<span class="co">#&gt; Fitting omega0,m0 for spectrum 1.ft2...</span>
<span class="co">#&gt; Fitting m0 for spectrum 2.ft2...</span>
<span class="co">#&gt; Fitting omega0,m0 for spectrum 2.ft2...</span>
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">".."</span>)
</pre></div>
<div id="output-files-2" class="section level3">
<h3 class="hasAnchor">
<a href="#output-files-2" class="anchor"></a>Output Files</h3>
<p>As in the refinement step, the script creates two files for each spectrum, whose names are derived from the spectrum filenames. Here the output associated with <code>2.ft2</code> is shown, as the output for <code>1.ft2</code> is very similar to the previous section.</p>
<p><code>*_fit.pdf</code> shows the overall spectrum. Pay particular attention to where the small blue circle is located in the gray rectangle. You may want to adjust <code>omega0_r2_factor</code> to increase or decrease the stringency of the <code>omega0</code> constraint, or possibly choose a different spectrum to use for <code>start_volume.csv</code>.</p>
<p><img src="extend/2_fit.png" width="672"></p>
<p><code>*_volume.csv</code> contains all the identified peaks, along with a column for the volume found in that spectrum.</p>
<table class="table">
<thead><tr class="header">
<th align="right">peak</th>
<th align="right">fit</th>
<th align="right">omega0_ppm_1</th>
<th align="right">omega0_ppm_2</th>
<th align="right">sc_hz_1</th>
<th align="right">r2_hz_1</th>
<th align="right">r2_hz_2</th>
<th align="right">2.ft2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">8.2491</td>
<td align="right">121.87</td>
<td align="right">3.3463</td>
<td align="right">2.8966</td>
<td align="right">2.31700</td>
<td align="right">231872819</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">1</td>
<td align="right">8.2612</td>
<td align="right">121.93</td>
<td align="right">3.3463</td>
<td align="right">2.8966</td>
<td align="right">2.31700</td>
<td align="right">67997595</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">2</td>
<td align="right">8.5409</td>
<td align="right">119.76</td>
<td align="right">2.0000</td>
<td align="right">5.6996</td>
<td align="right">2.07427</td>
<td align="right">321746353</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">3</td>
<td align="right">8.6139</td>
<td align="right">123.37</td>
<td align="right">9.4647</td>
<td align="right">3.2950</td>
<td align="right">2.36758</td>
<td align="right">220800433</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">4</td>
<td align="right">8.5869</td>
<td align="right">123.04</td>
<td align="right">6.0587</td>
<td align="right">6.5823</td>
<td align="right">1.79531</td>
<td align="right">176274429</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">3</td>
<td align="right">8.6458</td>
<td align="right">123.45</td>
<td align="right">9.4647</td>
<td align="right">3.2950</td>
<td align="right">2.36758</td>
<td align="right">44076003</td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="right">4</td>
<td align="right">8.5377</td>
<td align="right">122.97</td>
<td align="right">6.0587</td>
<td align="right">6.5823</td>
<td align="right">1.79531</td>
<td align="right">43199279</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">5</td>
<td align="right">8.3584</td>
<td align="right">119.89</td>
<td align="right">10.1581</td>
<td align="right">1.7366</td>
<td align="right">4.73950</td>
<td align="right">238007135</td>
</tr>
<tr class="odd">
<td align="right">9</td>
<td align="right">5</td>
<td align="right">8.3748</td>
<td align="right">119.88</td>
<td align="right">10.1581</td>
<td align="right">1.7366</td>
<td align="right">4.73950</td>
<td align="right">36138286</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">6</td>
<td align="right">8.2520</td>
<td align="right">119.41</td>
<td align="right">6.0938</td>
<td align="right">5.0267</td>
<td align="right">1.77685</td>
<td align="right">211286779</td>
</tr>
<tr class="odd">
<td align="right">11</td>
<td align="right">6</td>
<td align="right">8.2913</td>
<td align="right">119.39</td>
<td align="right">6.0938</td>
<td align="right">5.0267</td>
<td align="right">1.77685</td>
<td align="right">49843412</td>
</tr>
<tr class="even">
<td align="right">12</td>
<td align="right">7</td>
<td align="right">8.4830</td>
<td align="right">122.49</td>
<td align="right">9.4013</td>
<td align="right">5.0804</td>
<td align="right">2.41291</td>
<td align="right">171865386</td>
</tr>
<tr class="odd">
<td align="right">13</td>
<td align="right">7</td>
<td align="right">8.4754</td>
<td align="right">123.00</td>
<td align="right">9.4013</td>
<td align="right">5.0804</td>
<td align="right">2.41291</td>
<td align="right">36056767</td>
</tr>
<tr class="even">
<td align="right">14</td>
<td align="right">8</td>
<td align="right">8.4448</td>
<td align="right">120.73</td>
<td align="right">9.1220</td>
<td align="right">4.8623</td>
<td align="right">3.19661</td>
<td align="right">122206500</td>
</tr>
<tr class="odd">
<td align="right">15</td>
<td align="right">8</td>
<td align="right">8.4259</td>
<td align="right">120.48</td>
<td align="right">9.1220</td>
<td align="right">4.8623</td>
<td align="right">3.19661</td>
<td align="right">28602978</td>
</tr>
<tr class="even">
<td align="right">16</td>
<td align="right">8</td>
<td align="right">8.4677</td>
<td align="right">120.51</td>
<td align="right">9.1220</td>
<td align="right">4.8623</td>
<td align="right">3.19661</td>
<td align="right">19245838</td>
</tr>
<tr class="odd">
<td align="right">17</td>
<td align="right">9</td>
<td align="right">8.3460</td>
<td align="right">120.77</td>
<td align="right">8.3984</td>
<td align="right">1.5894</td>
<td align="right">0.91155</td>
<td align="right">35368718</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="transferring-assignments" class="section level2">
<h2 class="hasAnchor">
<a href="#transferring-assignments" class="anchor"></a>Transferring Assignments</h2>
<p>FitNMR can also transfer previously determined peak assignments onto the peak lists. This will be done in the <code>extend</code> directory used above. For this tutorial, assignments for the subregion of the spectrum are also provided, which should be copied into that directory and given the name <code>assignments.csv</code> using:</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"t1"</span>, <span class="st">"assignments.csv"</span>, package=<span class="st">"fitnmr"</span>), <span class="st">"extend"</span>, overwrite=<span class="fl">TRUE</span>)
</pre></div>
<p>The <code>assignments.csv</code> file should contain a header and three columns. The text in the header is ignored, but the order of the columns must be:</p>
<ol style="list-style-type: decimal">
<li>Peak identifier</li>
<li>PPM in dimension 1</li>
<li>PPM in dimension 2</li>
</ol>
<p>The <code>assignments.csv</code> file used here contains eight peaks:</p>
<table class="table">
<thead><tr class="header">
<th align="right">res</th>
<th align="right">hn_ppm</th>
<th align="right">n_ppm</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">2</td>
<td align="right">8.517</td>
<td align="right">120.56</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">8.565</td>
<td align="right">122.23</td>
</tr>
<tr class="odd">
<td align="right">16</td>
<td align="right">8.573</td>
<td align="right">119.43</td>
</tr>
<tr class="even">
<td align="right">19</td>
<td align="right">8.323</td>
<td align="right">119.23</td>
</tr>
<tr class="odd">
<td align="right">20</td>
<td align="right">8.646</td>
<td align="right">122.87</td>
</tr>
<tr class="even">
<td align="right">21</td>
<td align="right">8.288</td>
<td align="right">121.61</td>
</tr>
<tr class="odd">
<td align="right">26</td>
<td align="right">8.431</td>
<td align="right">119.73</td>
</tr>
<tr class="even">
<td align="right">27</td>
<td align="right">8.679</td>
<td align="right">122.89</td>
</tr>
</tbody>
</table>
<p>The script that transfers the assignments is called <code>assign_peaks_2d.R</code> and should also be copied into the <code>extend</code> directory:</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"demo"</span>, <span class="st">"assign_peaks_2d.R"</span>, package=<span class="st">"fitnmr"</span>), <span class="st">"extend"</span>, overwrite=<span class="fl">TRUE</span>)
</pre></div>
<p>There are a number of parameters at the top of that script that can be customized:</p>
<pre><code># Input Files:
#  assignments.csv: assignments to transfer to *_volume.csv files
#  *_volume.csv: peak parameters to be assigned (each must have same number of peaks)
#  *.ft2: 2D spectra associated with each *_volume.csv file
#  start_volume.csv (optional): *_volume.csv file most similar to this used for assignment

# Output Files
#  assign_volume.csv: assigned peaks, median parameters, and aggregated volumes
#  assign_stages.pdf: contour plot showing both assignment stages
#  assign_omegas.pdf: contour plot showing final peak assignments


# Assignment Parameters:

# peak assignment stage 1 adjustment (for first and second dimensions, respectively)
cs_adj_1 &lt;- c(0, 0)

# peak assignment stage 1 distance threshold (fraction of chemical shift range)
thresh_1 &lt;- 0.1

# peak assignment stage 1 adjustment (for first and second dimensions, respectively)
cs_adj_2 &lt;- c(0, 0)

# peak assignment stage 2 distance threshold (fraction of chemical shift range)
thresh_2 &lt;- 0.025


# Plotting Parameters:

# lowest contour in *_fit.pdf will be this number times the noise level
plot_noise_cutoff &lt;- 4

# scaling factor for fit_spectra.pdf labels
cex &lt;- 0.2

# plot ovals showing the thresholds for peak assignment transfer
plot_thresh &lt;- TRUE

# color for unmatched peaks/assignments
unmatched_col &lt;- "purple"</code></pre>
<p>The assignment transfer uses a FitNMR function called <code><a href="../reference/height_assign.html">height_assign()</a></code> that goes through each peak the spectrum in order of decreasing height/volume, and assigns it to the closest position in the assignment list that is within some threshold distance. Internally, the chemical shifts in each dimension are normalized by the range of values in that dimension. The threshold is given in those normalized units, such that a value of 0.1 would allow a difference of no more than 10% of the spectral width in each dimension, or less for diagonally adjacent peaks. The algorithm does not assign multiple peaks to the same identifier.</p>
<p>To help automatically handle differences in referencing between the spectra and input assignments, the algorithm uses <code><a href="../reference/height_assign.html">height_assign()</a></code> in two different stages. The first stage uses a larger threshold to handle cases where the referencing is quite different. After that initial assignment, the median offsets between the spectra and input assignments (in each dimension) are used to shift the input assignments. As long as there are enough isolated peaks that can be correctly assigned in the first stage, this is often sufficient to automatically correct the referencing for a more stringent second stage. The thresholds for both stages (<code>thresh_1</code> and <code>thresh_2</code>) can be tailored individually. In addition, the assigned chemical shifts can be manually adjusted for each stage (using <code>cs_adj_2</code> and <code>cs_adj_2</code>) to help in cases where the referencing cannot be automatically corrected.</p>
<p>Because this is a subspectrum, the default values for the thresholds do not work as well. Furthermore, while the whole spectrum has enough peaks to automatically determine the correct offset after stage 1, the subspectrum does not, so the proton assignments are manually shifted 0.02 ppm to the left to compensate. For this tutorial, that is done with the following code:</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="kw">script_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"extend"</span>, <span class="st">"assign_peaks_2d.R"</span>))
<span class="kw">script_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span>(<span class="st">"thresh_1 &lt;- 0.1"</span>, <span class="st">"thresh_1 &lt;- 0.2"</span>, <span class="kw">script_lines</span>)
<span class="kw">script_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span>(<span class="st">"cs_adj_2 &lt;- c\\(0, 0\\)"</span>, <span class="st">"cs_adj_2 &lt;- c(-0.02, 0)"</span>, <span class="kw">script_lines</span>)
<span class="kw">script_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span>(<span class="st">"thresh_2 &lt;- 0.025"</span>, <span class="st">"thresh_2 &lt;- 0.075"</span>, <span class="kw">script_lines</span>)
<span class="fu"><a href="https://rdrr.io/r/base/writeLines.html">writeLines</a></span>(<span class="kw">script_lines</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"extend"</span>, <span class="st">"assign_peaks_2d.R"</span>))
</pre></div>
<p>The modified part of the script should now read:</p>
<pre><code># peak assignment stage 1 distance threshold (fraction of chemical shift range)
thresh_1 &lt;- 0.2

# peak assignment stage 1 adjustment (for first and second dimensions, respectively)
cs_adj_2 &lt;- c(-0.02, 0)

# peak assignment stage 2 distance threshold (fraction of chemical shift range)
thresh_2 &lt;- 0.075</code></pre>
<p>The <code>assign_peaks_2d.R</code> script should then be run from within the <code>extend</code> directory:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">"extend"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"assign_peaks_2d.R"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">".."</span>)
</pre></div>
<div id="output-files-3" class="section level3">
<h3 class="hasAnchor">
<a href="#output-files-3" class="anchor"></a>Output Files</h3>
<p>Three output files are generated by the ‘assign_peaks_2d.R’ script:</p>
<ul>
<li><code>assign_stages.pdf</code></li>
<li><code>assign_omegas.pdf</code></li>
<li><code>assign_volume.csv</code></li>
</ul>
<p><code>assign_stages.pdf</code> shows the two stages used for the assignment transfer. The gray points show the chemical shifts of the input assignments after <code>cs_adj_1</code> has been applied. The peaks matched to those assignments in stage 1 are connected by gray lines. A larger gray oval around each input assignment shows the size of <code>thresh_1</code>. The adjusted input assignment chemical shifts used for stage 2 are shown in green, with smaller ovals indicating a more stringent <code>thresh_2</code>. Any input assignment not matched to a peak has its label drawn in purple. Likewise, any peak not matched to an input assignment is labeled in purple.</p>
<p><img src="extend/assign_stages.png" width="672"></p>
<p><code>assign_omegas.pdf</code> shows the final results of the assignment transfer, with the identifier of an assigned peak shown above the peak, and unassigned peaks labeled in purple. In addition, the peak positions from all of the fit spectra are shown as very small points, which are difficult to see here and are best viewed by zooming into the PDF generated by this step. An attempt is made to color each peak in a given group differently.</p>
<p><img src="extend/assign_omegas.png" width="672"></p>
<p><code>assign_volume.csv</code> contains all the peaks, with the assigned identifier in the first column. The peak positions, scalar couplings, and relaxation rates in this table give the median values from all the individual fits. There is also a column for the volume found in each spectrum.</p>
<table class="table">
<thead><tr class="header">
<th align="left">assignment</th>
<th align="right">peak</th>
<th align="right">fit</th>
<th align="right">omega0_ppm_1</th>
<th align="right">omega0_ppm_2</th>
<th align="right">sc_hz_1</th>
<th align="right">r2_hz_1</th>
<th align="right">r2_hz_2</th>
<th align="right">1.ft2</th>
<th align="right">2.ft2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">21</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">8.2484</td>
<td align="right">121.87</td>
<td align="right">3.3463</td>
<td align="right">2.8966</td>
<td align="right">2.31700</td>
<td align="right">823654203</td>
<td align="right">231872819</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="right">2</td>
<td align="right">1</td>
<td align="right">8.2604</td>
<td align="right">121.93</td>
<td align="right">3.3463</td>
<td align="right">2.8966</td>
<td align="right">2.31700</td>
<td align="right">239522805</td>
<td align="right">67997595</td>
</tr>
<tr class="odd">
<td align="left">16</td>
<td align="right">3</td>
<td align="right">2</td>
<td align="right">8.5402</td>
<td align="right">119.76</td>
<td align="right">2.0000</td>
<td align="right">5.6996</td>
<td align="right">2.07427</td>
<td align="right">1120538907</td>
<td align="right">321746353</td>
</tr>
<tr class="even">
<td align="left">27</td>
<td align="right">4</td>
<td align="right">3</td>
<td align="right">8.6131</td>
<td align="right">123.37</td>
<td align="right">9.4647</td>
<td align="right">3.2950</td>
<td align="right">2.36758</td>
<td align="right">777522598</td>
<td align="right">220800433</td>
</tr>
<tr class="odd">
<td align="left">20</td>
<td align="right">5</td>
<td align="right">4</td>
<td align="right">8.5861</td>
<td align="right">123.04</td>
<td align="right">6.0587</td>
<td align="right">6.5823</td>
<td align="right">1.79531</td>
<td align="right">632568971</td>
<td align="right">176274429</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="right">6</td>
<td align="right">3</td>
<td align="right">8.6449</td>
<td align="right">123.45</td>
<td align="right">9.4647</td>
<td align="right">3.2950</td>
<td align="right">2.36758</td>
<td align="right">163968675</td>
<td align="right">44076003</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="right">7</td>
<td align="right">4</td>
<td align="right">8.5373</td>
<td align="right">122.96</td>
<td align="right">6.0587</td>
<td align="right">6.5823</td>
<td align="right">1.79531</td>
<td align="right">151175459</td>
<td align="right">43199279</td>
</tr>
<tr class="even">
<td align="left">26</td>
<td align="right">8</td>
<td align="right">5</td>
<td align="right">8.3579</td>
<td align="right">119.89</td>
<td align="right">10.1581</td>
<td align="right">1.7366</td>
<td align="right">4.73950</td>
<td align="right">802920758</td>
<td align="right">238007135</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="right">9</td>
<td align="right">5</td>
<td align="right">8.3748</td>
<td align="right">119.89</td>
<td align="right">10.1581</td>
<td align="right">1.7366</td>
<td align="right">4.73950</td>
<td align="right">97111602</td>
<td align="right">36138286</td>
</tr>
<tr class="even">
<td align="left">19</td>
<td align="right">10</td>
<td align="right">6</td>
<td align="right">8.2513</td>
<td align="right">119.41</td>
<td align="right">6.0938</td>
<td align="right">5.0267</td>
<td align="right">1.77685</td>
<td align="right">731306564</td>
<td align="right">211286779</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="right">11</td>
<td align="right">6</td>
<td align="right">8.2907</td>
<td align="right">119.38</td>
<td align="right">6.0938</td>
<td align="right">5.0267</td>
<td align="right">1.77685</td>
<td align="right">180469286</td>
<td align="right">49843412</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="right">12</td>
<td align="right">7</td>
<td align="right">8.4825</td>
<td align="right">122.49</td>
<td align="right">9.4013</td>
<td align="right">5.0804</td>
<td align="right">2.41291</td>
<td align="right">587358952</td>
<td align="right">171865386</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="right">13</td>
<td align="right">7</td>
<td align="right">8.4750</td>
<td align="right">123.01</td>
<td align="right">9.4013</td>
<td align="right">5.0804</td>
<td align="right">2.41291</td>
<td align="right">108283049</td>
<td align="right">36056767</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">14</td>
<td align="right">8</td>
<td align="right">8.4441</td>
<td align="right">120.73</td>
<td align="right">9.1220</td>
<td align="right">4.8623</td>
<td align="right">3.19661</td>
<td align="right">436473368</td>
<td align="right">122206500</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="right">15</td>
<td align="right">8</td>
<td align="right">8.4252</td>
<td align="right">120.47</td>
<td align="right">9.1220</td>
<td align="right">4.8623</td>
<td align="right">3.19661</td>
<td align="right">95383740</td>
<td align="right">28602978</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="right">16</td>
<td align="right">8</td>
<td align="right">8.4674</td>
<td align="right">120.52</td>
<td align="right">9.1220</td>
<td align="right">4.8623</td>
<td align="right">3.19661</td>
<td align="right">64431478</td>
<td align="right">19245838</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="right">17</td>
<td align="right">9</td>
<td align="right">8.3451</td>
<td align="right">120.76</td>
<td align="right">8.3984</td>
<td align="right">1.5894</td>
<td align="right">0.91155</td>
<td align="right">97878091</td>
<td align="right">35368718</td>
</tr>
</tbody>
</table>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://smithlab.wesleyan.edu">Colin Smith</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
