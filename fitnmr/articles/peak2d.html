<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Automated 2D Peak Fitting • fitnmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Automated 2D Peak Fitting">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fitnmr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/peak2d.html">Automated 2D Peak Fitting</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/smith-group/fitnmr">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="peak2d_files/jquery-1.11.3/jquery.min.js"></script><script src="peak2d_files/elevate-section-attrs-2.0/elevate-section-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Automated 2D Peak Fitting</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/smith-group/fitnmr/blob/master/vignettes/peak2d.Rmd"><code>vignettes/peak2d.Rmd</code></a></small>
      <div class="hidden name"><code>peak2d.Rmd</code></div>

    </div>

    
    
<p>FitNMR enables fully automated peak fitting of 2D NMR spectra. This document is split into two sections. The first section demonstrates how fitting can be done using <code>R</code> code, various stages of the algorithm, and some of the ways that the results can be visualized. The second section, “Fitting Peaks without Coding”, shows how the same fitting can be done with very little manual code entry using two convenience scripts, <code>fit_peaks_2d.R</code> and <code>refit_peaks_2d.R</code>.</p>
<p>The following tutorial will assume you have loaded the FitNMR package.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(fitnmr)</span></code></pre></div>
<div id="sample-data" class="section level2">
<h2 class="hasAnchor">
<a href="#sample-data" class="anchor"></a>Sample Data</h2>
<p>The first step in peak picking is to load one or more spectra. There are a number of example spectra that come with the FitNMR package. For this tutorial, we will be using spectra from a T<sub>1</sub> measurement of a small <em>de novo</em> designed mini-protein. The directory containing that data and the spectrum filenames can be determined with the following commands:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>t1_dir &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"t1"</span>, <span class="dt">package=</span><span class="st">"fitnmr"</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a>t1_ft2_filenames &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(t1_dir, <span class="dt">pattern=</span><span class="st">".ft2"</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a>t1_ft2_filenames</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">#&gt; [1] "1.ft2" "2.ft2"</span></span></code></pre></div>
</div>
<div id="reading-spectra" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-spectra" class="anchor"></a>Reading Spectra</h2>
<p>The <code>read_nmrpipe</code> function is used to read NMRPipe-formatted spectra.</p>
<p>To read both files, we will use the <code>lapply</code> function in R. It builds a list data structure by iterating over the items in the first argument and applying the function given in the second argument to each. Any subsequent arguments are passed to the function when it is called. The <code>file.path</code> function joins the directory where the files are located to the file names.</p>
<p>The <code>dim_order="hx"</code> argument tells <code>read_nmrpipe</code> to reorder the dimensions of the spectra so that the <sup>1</sup>H dimension is first. This is important as most default NMRPipe processing scripts will leave the <sup>1</sup>H as the second dimension. After reading a list of spectra, we will assign names to the list of spectra using the original filenames.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>spec_list &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(t1_dir, t1_ft2_filenames), read_nmrpipe, <span class="dt">dim_order=</span><span class="st">"hx"</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(spec_list) &lt;-<span class="st"> </span>t1_ft2_filenames</span></code></pre></div>
<p>The underlying data structures used to store the two spectra can be shown with the <code>str</code> function:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(spec_list)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">#&gt; List of 2</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">#&gt;  $ 1.ft2:List of 4</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co">#&gt;   ..$ int    : num [1:66, 1:45] 1243 1033 2060 2653 2102 ...</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">#&gt;   .. .. ..$ HN : chr [1:66] "8.6770160099608" "8.66967763204871" "8.66233925413663" "8.65500087622454" ...</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">#&gt;   .. .. ..$ N15: chr [1:45] "124.032918497401" "123.917245763118" "123.801573028835" "123.685900294552" ...</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">#&gt;   ..$ ppm    :List of 2</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">#&gt;   .. ..$ HN : num [1:66] 8.68 8.67 8.66 8.66 8.65 ...</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">#&gt;   .. ..$ N15: num [1:45] 124 124 124 124 124 ...</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="co">#&gt;   ..$ fheader: num [1:29, 1:2] 1 4.77 533 2048 799.74 ...</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">#&gt;   .. .. ..$ : chr [1:29] "QUADFLAG" "CAR" "CENTER" "FTSIZE" ...</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">#&gt;   .. .. ..$ : chr [1:2] "HN" "N15"</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">#&gt;   ..$ header : Named num [1:512] 0.00 4.01e+09 2.35 0.00 0.00 ...</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co">#&gt;   .. ..- attr(*, "names")= chr [1:512] "FDMAGIC" "FDFLTFORMAT" "FDFLTORDER" "" ...</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="co">#&gt;  $ 2.ft2:List of 4</span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="co">#&gt;   ..$ int    : num [1:66, 1:45] -679 -355 260 642 413 ...</span></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="co">#&gt;   .. .. ..$ HN : chr [1:66] "8.6770160099608" "8.66967763204871" "8.66233925413663" "8.65500087622454" ...</span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="co">#&gt;   .. .. ..$ N15: chr [1:45] "124.032918497401" "123.917245763118" "123.801573028835" "123.685900294552" ...</span></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="co">#&gt;   ..$ ppm    :List of 2</span></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="co">#&gt;   .. ..$ HN : num [1:66] 8.68 8.67 8.66 8.66 8.65 ...</span></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="co">#&gt;   .. ..$ N15: num [1:45] 124 124 124 124 124 ...</span></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="co">#&gt;   ..$ fheader: num [1:29, 1:2] 1 4.77 533 2048 799.74 ...</span></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="co">#&gt;   .. ..- attr(*, "dimnames")=List of 2</span></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="co">#&gt;   .. .. ..$ : chr [1:29] "QUADFLAG" "CAR" "CENTER" "FTSIZE" ...</span></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="co">#&gt;   .. .. ..$ : chr [1:2] "HN" "N15"</span></span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="co">#&gt;   ..$ header : Named num [1:512] 0.00 4.01e+09 2.35 0.00 0.00 ...</span></span>
<span id="cb4-30"><a href="#cb4-30"></a><span class="co">#&gt;   .. ..- attr(*, "names")= chr [1:512] "FDMAGIC" "FDFLTFORMAT" "FDFLTORDER" "" ...</span></span></code></pre></div>
<p>This shows that there is a list of two spectra. Each spectrum is itself a list with four named components:</p>
<ol style="list-style-type: decimal">
<li>
<code>int</code>: A multidimensional array with the intensities of the spectrum, which in this case it is just a 2D matrix. The chemical shifts are stored in character format in the dimension names (<code>dimnames</code>) of the array.</li>
<li>
<code>ppm</code>: A list of chemical shifts for each dimension stored in numeric format.</li>
<li>
<code>fheader</code>: A matrix of header values associated each dimension.</li>
<li>
<code>header</code>: The raw data from the 512-value NMRPipe header.</li>
</ol>
</div>
<div id="displaying-spectra" class="section level2">
<h2 class="hasAnchor">
<a href="#displaying-spectra" class="anchor"></a>Displaying Spectra</h2>
<p>We can produce a contour plot first spectrum using the <code>contour_pipe</code> function. It takes a matrix as input, so we must extract the <code>int</code> matrix of the first spectrum with the syntax shown.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw"><a href="../reference/contour_pipe.html">contour_pipe</a></span>(spec_list[[<span class="dv">1</span>]]<span class="op">$</span>int)</span></code></pre></div>
<p><img src="peak2d_files/figure-html/unnamed-chunk-6-1.png" width="672" style="display: block; margin: auto auto auto 0;"></p>
<p>As you can see above, the spectrum has a number of overlapped peaks with possible shoulders.</p>
</div>
<div id="estimating-noise" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-noise" class="anchor"></a>Estimating Noise</h2>
<p>The automated peak fitting procedure uses the noise level of each spectrum to determine a cutoff below which peaks will no longer be added. FitNMR includes a function, <code>noise_estimate</code>, for determining the noise level by fitting a Gaussian function to a histogram of the signal intensities.</p>
<p>The <code>sapply</code> function below is similar to the <code>lapply</code> function used above, but it attempts to simplify the output of each function into a matrix. In this case, because a vector of three numerical values is returned each time <code>noise_estimate</code> is called, a 3xN matrix of results is created. Also, because the <code>noise_estimate</code> function just takes numerical intensities, the code below defines a short inline function to extract those from each spectrum.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>noise_mat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(spec_list, <span class="cf">function</span>(x) <span class="kw"><a href="../reference/noise_estimate.html">noise_estimate</a></span>(x<span class="op">$</span>int))</span>
<span id="cb6-2"><a href="#cb6-2"></a>noise_mat</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">#&gt;           1.ft2     2.ft2</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">#&gt; mu       928.52    385.31</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#&gt; sigma   1097.91    739.07</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">#&gt; max   404348.28 116520.75</span></span></code></pre></div>
<p>The resulting matrix above gives the mean value the noise is centered on (<code>mu</code>), the standard deviation of the noise (<code>sigma</code>), and the maximum intensity in the spectrum (<code>max</code>).</p>
<p>The <code>noise_estimate</code> function can create plots showing the histogram of the intensity values (black) and the fit Gaussian function (blue). S/N is defined as <code>max/sigma</code>.</p>
<p><img src="peak2d_files/figure-html/noise-1.png" width="288"><img src="peak2d_files/figure-html/noise-2.png" width="288"></p>
<p>To identify an initial set of peaks, better results will probably be obtained using the spectrum with the highest signal-to-noise ratio, which in this case is the first spectrum.</p>
</div>
<div id="fitting-peaks" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-peaks" class="anchor"></a>Fitting Peaks</h2>
<div id="fitting-a-few-peak-clusters" class="section level3">
<h3 class="hasAnchor">
<a href="#fitting-a-few-peak-clusters" class="anchor"></a>Fitting a Few Peak Clusters</h3>
<p>We will start by running three iterations of the iterative peak fitting method. It takes a list of spectra, which we previously read. In this case, we will only do the fitting on the first spectrum. To get a list of just one spectrum, use single square brackets, <code>[ ]</code>, which return another list. (By contrast double square brackets, <code>[[ ]]</code>, return individual items from the list that are not enclosed in a list data structure.) The <code>iter_max</code> argument specifies the number of iterations to perform.</p>
<p>FitNMR outputs text describing what the peak fitting algorithm is doing. Adding the first peak involves addition of 6 parameters to the model (2 <code>omega0</code>, 2 <code>r2</code>, 1 <code>m0</code>, and 1 scalar coupling). The probability of the observed improvement to the fit happening at random (according to an F-test) is given by the p-value. For the first peak added, this is very low, indicating that having a peak at that position is much better than assuming otherwise. Adding the second peak involves addition of just 3 parameters (2 <code>omega0</code> and 1 <code>m0</code>), because several of the parameters are shared with the first peak (2 <code>r2</code> and 1 scalar coupling). For the first iteration, the search is terminated after the third peak fails to fall below the p-value cutoff, which is specified by <code>f_alpha</code> and defaults to <code>0.001</code>.</p>
<p>The <code>fit_peak_iter</code> function returns a list of fits, one for each iteration. To convert that into a more user-friendly table, use the <code>param_list_to_peak_df</code> function. The first couple columns of that table give the peak number and fit iteration at which the peak was added. If applicable the F-test p-value will be given next. The next several columns give the peak position (in ppm), the scalar coupling (in Hz), and the R<sub>2</sub> (in Hz), with the integer suffix indicating the dimension for each parameter. The remaining columns give the peak volumes from each spectrum.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>peak_fits &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fit_peak_iter.html">fit_peak_iter</a></span>(spec_list[<span class="dv">1</span>], <span class="dt">iter_max=</span><span class="dv">3</span>)</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co">#&gt; Fit iteration 1:</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 333.8 (p = 4.56642e-10)</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 64.6 (p = 1.11899e-05)</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 1.2 (p = 0.464419)</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co">#&gt; Fit iteration 2:</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 734.0 (p = 1.87653e-15)</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 14.7 (p = 0.000581712)</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 0.1 (p = 0.976358)</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="co">#&gt; Fit iteration 3:</span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 27.7 (p = 7.52698e-13)</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 226.0 (p = 2.5923e-27)</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 13.3 (p = 1.34241e-05)</span></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="co">#&gt;  12 -&gt; 15 fit parameters: F = 68.7 (p = 1.46797e-13)</span></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="co">#&gt;  15 -&gt; 18 fit parameters: F = 7.0 (p = 0.00144316)</span></span>
<span id="cb7-18"><a href="#cb7-18"></a><span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>peak_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/param_list_to_peak_df.html">param_list_to_peak_df</a></span>(peak_fits)</span>
<span id="cb7-20"><a href="#cb7-20"></a>peak_df</span>
<span id="cb7-21"><a href="#cb7-21"></a><span class="co">#&gt;   peak fit   f_pvalue omega0_ppm_1 omega0_ppm_2 sc_hz_1 r2_hz_1 r2_hz_2      1.ft2</span></span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="co">#&gt; 1    1   1 4.5664e-10       8.2476       121.87  3.2806  2.9072  2.3345  824420657</span></span>
<span id="cb7-23"><a href="#cb7-23"></a><span class="co">#&gt; 2    2   1 1.1190e-05       8.2596       121.93  3.2806  2.9072  2.3345  240560662</span></span>
<span id="cb7-24"><a href="#cb7-24"></a><span class="co">#&gt; 3    3   2 1.8765e-15       8.5400       119.76  2.0000  4.7886  2.0996 1020008726</span></span>
<span id="cb7-25"><a href="#cb7-25"></a><span class="co">#&gt; 4    4   2 5.8171e-04       8.5202       119.73  2.0000  4.7886  2.0996   89977216</span></span>
<span id="cb7-26"><a href="#cb7-26"></a><span class="co">#&gt; 5    5   3 7.5270e-13       8.6124       123.36  7.6481  5.2849  2.1801  848579189</span></span>
<span id="cb7-27"><a href="#cb7-27"></a><span class="co">#&gt; 6    6   3 2.5923e-27       8.5853       123.03  7.6481  5.2849  2.1801  607904936</span></span>
<span id="cb7-28"><a href="#cb7-28"></a><span class="co">#&gt; 7    7   3 1.3424e-05       8.6449       123.47  7.6481  5.2849  2.1801  147984411</span></span>
<span id="cb7-29"><a href="#cb7-29"></a><span class="co">#&gt; 8    8   3 1.4680e-13       8.5370       122.96  7.6481  5.2849  2.1801  161971930</span></span>
<span id="cb7-30"><a href="#cb7-30"></a><span class="kw"><a href="../reference/plot_peak_df.html">plot_peak_df</a></span>(peak_df, spec_list[<span class="dv">1</span>], <span class="dt">cex=</span><span class="fl">0.6</span>)</span></code></pre></div>
<p><img src="peak2d_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto auto auto 0;"></p>
<p>A plot of the resulting peak fits can be produced with the <code>plot_peak_df</code> function, which requires a peak table and list of spectra. It plots the peaks with contours down to 4 times the standard deviation of the noise present in the spectra. The modeled peaks are shown with red contours and the peak centers are indicated with blue dots, with the area of the blue dot proportional to the volume of the peak. Below each set of dots, the peaks are numbered with the syntax, <code>&lt;peak&gt;:&lt;fit&gt;</code>. All peaks in a given fit will share scalar coupling and R<sub>2</sub> parameters. If contained in the input table, the F-test p-value will be given below the peak number. This can be helpful in optimizing the the <code>f_alpha</code> parameter to avoid false negatives while minimizing the number of false positives.</p>
</div>
<div id="a-peek-inside-the-algorithm" class="section level3">
<h3 class="hasAnchor">
<a href="#a-peek-inside-the-algorithm" class="anchor"></a>A Peek Inside the Algorithm</h3>
<p>To take a more detailed look inside a single iteration of the algorithm, the <code>fit_peak_iter</code> function can be called again, providing the output of the first time it was run using the <code>fit_list</code> parameter. By setting the <code>plot_fit_stages</code> parameter to <code>TRUE</code>, FitNMR will produce a series of plots illustrating the progress of the algorithm.</p>
<p>A given iteration starts with placing a peak at the highest point in the spectrum, after all previously modeled peaks have been subtracted out. It first optimizes <code>m0</code>, leaving the <code>omega0</code>, <code>r2</code>, and <code>sc</code> parameters at their default values. The resulting peak is shown in the first plot, with red dots at the peak centers and lines <code>±r2</code> for each dimension.</p>
<p>After obtaining an initial volume, the peak shape is allowed to change by unfixing the <code>r2</code> and <code>sc</code> parameters. Subsequent plots are shown with blue contours showing peaks modeled with the input parameters in blue, and the fit parameters in red. Finally, the peak is allowed to move by unfixing the <code>omega0</code> parameters, with the center of each multiplet constrained to <code>±1.5*r2</code>, as indicated by the gray square.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>peak_fits &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fit_peak_iter.html">fit_peak_iter</a></span>(spec_list[<span class="dv">1</span>], <span class="dt">iter_max=</span><span class="dv">1</span>, <span class="dt">fit_list=</span>peak_fits, <span class="dt">plot_fit_stages=</span><span class="ot">TRUE</span>)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co">#&gt; Fit iteration 1:</span></span></code></pre></div>
<p><img src="peak2d_files/figure-html/unnamed-chunk-12-1.png" width="384" style="display: block; margin: auto auto auto 0;"><img src="peak2d_files/figure-html/unnamed-chunk-12-2.png" width="384" style="display: block; margin: auto auto auto 0;"><img src="peak2d_files/figure-html/unnamed-chunk-12-3.png" width="384" style="display: block; margin: auto auto auto 0;"></p>
<pre><code>#&gt;   0 -&gt;  6 fit parameters: F = 2022.7 (p = 1.60653e-20)</code></pre>
<p><img src="peak2d_files/figure-html/unnamed-chunk-12-4.png" width="384" style="display: block; margin: auto auto auto 0;"><img src="peak2d_files/figure-html/unnamed-chunk-12-5.png" width="384" style="display: block; margin: auto auto auto 0;"><img src="peak2d_files/figure-html/unnamed-chunk-12-6.png" width="384" style="display: block; margin: auto auto auto 0;"><img src="peak2d_files/figure-html/unnamed-chunk-12-7.png" width="384" style="display: block; margin: auto auto auto 0;"></p>
<pre><code>#&gt;   6 -&gt;  9 fit parameters: F = 14.0 (p = 0.000228688)</code></pre>
<p><img src="peak2d_files/figure-html/unnamed-chunk-12-8.png" width="384" style="display: block; margin: auto auto auto 0;"><img src="peak2d_files/figure-html/unnamed-chunk-12-9.png" width="384" style="display: block; margin: auto auto auto 0;"><img src="peak2d_files/figure-html/unnamed-chunk-12-10.png" width="384" style="display: block; margin: auto auto auto 0;"></p>
<pre><code>#&gt;  Terminating search because fit produced zero volume</code></pre>
<p>In this case, the last peak added was too close to the first and when all parameters were unfixed, one of the peaks had zero volume, which resulted in termination of this iteration. In this fit, the shoulder peak is present, but is less than 10% of the volume of the major peak. (See fit 4 in the peak lists below.) The newly added peak cluster is outlined in green in the spectrum below.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw"><a href="../reference/plot_peak_df.html">plot_peak_df</a></span>(<span class="kw"><a href="../reference/param_list_to_peak_df.html">param_list_to_peak_df</a></span>(peak_fits), spec_list[<span class="dv">1</span>], <span class="dt">cex=</span><span class="fl">0.6</span>)</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="kw"><a href="https://rdrr.io/r/graphics/rect.html">rect</a></span>(<span class="fl">8.41</span>, <span class="fl">120.6</span>, <span class="fl">8.31</span>, <span class="fl">119.2</span>, <span class="dt">border=</span><span class="st">"green"</span>)</span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/text.html">text</a></span>(<span class="fl">8.31</span>, <span class="fl">119.9</span>, <span class="st">"New Cluster"</span>, <span class="dt">pos=</span><span class="dv">4</span>, <span class="dt">col=</span><span class="st">"green"</span>)</span></code></pre></div>
<p><img src="peak2d_files/figure-html/unnamed-chunk-14-1.png" width="576" style="display: block; margin: auto auto auto 0;"></p>
</div>
<div id="fitting-the-remainder-of-the-peaks" class="section level3">
<h3 class="hasAnchor">
<a href="#fitting-the-remainder-of-the-peaks" class="anchor"></a>Fitting the Remainder of the Peaks</h3>
<p>To fit the remainder of the peaks, call the <code>fit_peak_iter</code> function again, this time leaving out the <code>iter_max</code> parameter so that the default value (100) is used.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>peak_fits &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fit_peak_iter.html">fit_peak_iter</a></span>(spec_list[<span class="dv">1</span>], <span class="dt">fit_list=</span>peak_fits)</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="co">#&gt; Fit iteration 1:</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 107.8 (p = 9.74212e-11)</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 260.6 (p = 2.04021e-13)</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 11.0 (p = 0.00161564)</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="co">#&gt; Fit iteration 2:</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 1219.7 (p = 6.27674e-21)</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 174.9 (p = 1.74543e-15)</span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 42.3 (p = 8.00775e-09)</span></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="co">#&gt;  12 -&gt; 15 fit parameters: F = 11.8 (p = 0.000186865)</span></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="co">#&gt;  15 -&gt; 18 fit parameters: F = 1.6 (p = 0.223018)</span></span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span></span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="co">#&gt; Fit iteration 3:</span></span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 232.0 (p = 1.0692e-22)</span></span>
<span id="cb13-16"><a href="#cb13-16"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 15.9 (p = 1.99824e-06)</span></span>
<span id="cb13-17"><a href="#cb13-17"></a><span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 54.3 (p = 1.15821e-11)</span></span>
<span id="cb13-18"><a href="#cb13-18"></a><span class="co">#&gt;  Terminating search because fit produced zero volume</span></span>
<span id="cb13-19"><a href="#cb13-19"></a><span class="co">#&gt; Fit iteration 4:</span></span>
<span id="cb13-20"><a href="#cb13-20"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 330.9 (p = 1.75035e-07)</span></span>
<span id="cb13-21"><a href="#cb13-21"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 1.8 (p = 0.274918)</span></span>
<span id="cb13-22"><a href="#cb13-22"></a><span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span></span>
<span id="cb13-23"><a href="#cb13-23"></a>peak_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/param_list_to_peak_df.html">param_list_to_peak_df</a></span>(peak_fits)</span>
<span id="cb13-24"><a href="#cb13-24"></a>peak_df</span>
<span id="cb13-25"><a href="#cb13-25"></a><span class="co">#&gt;    peak fit   f_pvalue omega0_ppm_1 omega0_ppm_2 sc_hz_1 r2_hz_1 r2_hz_2      1.ft2</span></span>
<span id="cb13-26"><a href="#cb13-26"></a><span class="co">#&gt; 1     1   1 4.5664e-10       8.2476       121.87  3.2806  2.9072 2.33450  824420657</span></span>
<span id="cb13-27"><a href="#cb13-27"></a><span class="co">#&gt; 2     2   1 1.1190e-05       8.2596       121.93  3.2806  2.9072 2.33450  240560662</span></span>
<span id="cb13-28"><a href="#cb13-28"></a><span class="co">#&gt; 3     3   2 1.8765e-15       8.5400       119.76  2.0000  4.7886 2.09965 1020008726</span></span>
<span id="cb13-29"><a href="#cb13-29"></a><span class="co">#&gt; 4     4   2 5.8171e-04       8.5202       119.73  2.0000  4.7886 2.09965   89977216</span></span>
<span id="cb13-30"><a href="#cb13-30"></a><span class="co">#&gt; 5     5   3 7.5270e-13       8.6124       123.36  7.6481  5.2849 2.18012  848579189</span></span>
<span id="cb13-31"><a href="#cb13-31"></a><span class="co">#&gt; 6     6   3 2.5923e-27       8.5853       123.03  7.6481  5.2849 2.18012  607904936</span></span>
<span id="cb13-32"><a href="#cb13-32"></a><span class="co">#&gt; 7     7   3 1.3424e-05       8.6449       123.47  7.6481  5.2849 2.18012  147984411</span></span>
<span id="cb13-33"><a href="#cb13-33"></a><span class="co">#&gt; 8     8   3 1.4680e-13       8.5370       122.96  7.6481  5.2849 2.18012  161971930</span></span>
<span id="cb13-34"><a href="#cb13-34"></a><span class="co">#&gt; 9     9   4 1.6065e-20       8.3580       119.89 10.2029  2.2306 5.03575  875241831</span></span>
<span id="cb13-35"><a href="#cb13-35"></a><span class="co">#&gt; 10   10   4 2.2869e-04       8.3791       119.90 10.2029  2.2306 5.03575   62766713</span></span>
<span id="cb13-36"><a href="#cb13-36"></a><span class="co">#&gt; 11   11   5 9.7421e-11       8.2506       119.41  6.3683  4.9091 1.85341  732475431</span></span>
<span id="cb13-37"><a href="#cb13-37"></a><span class="co">#&gt; 12   12   5 2.0402e-13       8.2900       119.38  6.3683  4.9091 1.85341  181301641</span></span>
<span id="cb13-38"><a href="#cb13-38"></a><span class="co">#&gt; 13   13   6 6.2767e-21       8.4826       122.50  9.1982  5.0619 2.03464  475854299</span></span>
<span id="cb13-39"><a href="#cb13-39"></a><span class="co">#&gt; 14   14   6 1.7454e-15       8.4629       122.91  9.1982  5.0619 2.03464   28166195</span></span>
<span id="cb13-40"><a href="#cb13-40"></a><span class="co">#&gt; 15   15   6 8.0078e-09       8.4768       123.03  9.1982  5.0619 2.03464   92626742</span></span>
<span id="cb13-41"><a href="#cb13-41"></a><span class="co">#&gt; 16   16   6 1.8687e-04       8.4786       122.43  9.1982  5.0619 2.03464  105607485</span></span>
<span id="cb13-42"><a href="#cb13-42"></a><span class="co">#&gt; 17   17   7 1.0692e-22       8.4433       120.73  7.1444  6.3350 2.97224  460752250</span></span>
<span id="cb13-43"><a href="#cb13-43"></a><span class="co">#&gt; 18   18   7 1.9982e-06       8.4251       120.46  7.1444  6.3350 2.97224   97674580</span></span>
<span id="cb13-44"><a href="#cb13-44"></a><span class="co">#&gt; 19   19   7 1.1582e-11       8.4663       120.51  7.1444  6.3350 2.97224   62014526</span></span>
<span id="cb13-45"><a href="#cb13-45"></a><span class="co">#&gt; 20   20   8 1.7504e-07       8.3444       120.76  8.6176  1.9530 0.86044  105614247</span></span>
<span id="cb13-46"><a href="#cb13-46"></a><span class="kw"><a href="../reference/plot_peak_df.html">plot_peak_df</a></span>(peak_df, spec_list[<span class="dv">1</span>], <span class="dt">cex=</span><span class="fl">0.6</span>)</span></code></pre></div>
<p><img src="peak2d_files/figure-html/unnamed-chunk-15-1.png" width="672" style="display: block; margin: auto auto auto 0;"></p>
</div>
</div>
<div id="fitting-peaks-without-scalar-couplings" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-peaks-without-scalar-couplings" class="anchor"></a>Fitting Peaks without Scalar Couplings</h2>
<p>Scalar couplings are only fit for specified dimensions. The only type of splitting pattern currently supported is a doublet. The particular dimensions for which scalar couplings are fit is specified with the <code>sc_start</code> parameter, which should be a two-element numeric vector. The first element of that vector gives the starting value of the scalar coupling in the first dimension, and likewise for the second dimension. If a given dimension is set to <code>NA</code>, then it will not have a doublet generated. If <code>sc_start</code> is left at the default value of <code><a href="https://rdrr.io/r/base/c.html">c(6, NA)</a></code>, then there will just be a doublet fit in the first dimension, with only a single peak fit in the second dimension. To disable scalar couplings altogether, set <code>sc_start</code> to <code><a href="https://rdrr.io/r/base/c.html">c(NA, NA)</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>peak_fits_no_sc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fit_peak_iter.html">fit_peak_iter</a></span>(spec_list[<span class="dv">1</span>], <span class="dt">sc_start=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="ot">NA</span>, <span class="ot">NA</span>))</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="kw"><a href="../reference/plot_peak_df.html">plot_peak_df</a></span>(<span class="kw"><a href="../reference/param_list_to_peak_df.html">param_list_to_peak_df</a></span>(peak_fits_no_sc), spec_list[<span class="dv">1</span>], <span class="dt">cex=</span><span class="fl">0.6</span>)</span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/rect.html">rect</a></span>(<span class="fl">8.55</span>, <span class="fl">122.8</span>, <span class="fl">8.43</span>, <span class="fl">122.1</span>, <span class="dt">border=</span><span class="st">"green"</span>)</span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="kw"><a href="https://rdrr.io/r/graphics/text.html">text</a></span>(<span class="fl">8.43</span>, <span class="fl">122.5</span>, <span class="st">"Coupling</span><span class="ch">\n</span><span class="st">Detected</span><span class="ch">\n</span><span class="st">de novo"</span>, <span class="dt">pos=</span><span class="dv">4</span>, <span class="dt">col=</span><span class="st">"green"</span>)</span></code></pre></div>
<p><img src="peak2d_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<p>Many of the peaks in the above plot can be fit reasonably well without scalar couplings, but the contours do not necessarily match up as well. For one peak boxed in green above, a scalar coupling is detected <em>de novo</em> by the fitting algorithm, with two adjacent peaks having roughly the same volume.</p>
</div>
<div id="editing-fit-clusters" class="section level2">
<h2 class="hasAnchor">
<a href="#editing-fit-clusters" class="anchor"></a>Editing Fit Clusters</h2>
<div id="separating-fit-clusters" class="section level3">
<h3 class="hasAnchor">
<a href="#separating-fit-clusters" class="anchor"></a>Separating Fit Clusters</h3>
<p>After performing an initial fit, there may be large clusters of peaks that can be separated into different clusters and refit to allow the peak shapes to take on different values. For instance, peaks 5 and 7 shown in “Splitting the Reminder of Peaks” above are sufficiently separated from peaks 6 and 8 in both the vertical and horizontal dimensions, such that it should be possible to fit different peak shape parameters. To separate them out into their own cluster, reassign them a new “fit” cluster that is greater than any other fit group.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>edited_peak_df &lt;-<span class="st"> </span>peak_df</span>
<span id="cb15-2"><a href="#cb15-2"></a>edited_peak_df[<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">5</span>,<span class="dv">7</span>),<span class="st">"fit"</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(edited_peak_df[,<span class="st">"fit"</span>])<span class="op">+</span><span class="dv">1</span></span></code></pre></div>
</div>
<div id="deleting-peaks" class="section level3">
<h3 class="hasAnchor">
<a href="#deleting-peaks" class="anchor"></a>Deleting Peaks</h3>
<p>Furthermore, you may find that the algorithm has been overzealous and detected peaks that do not appear to be real after visual inspection, for instance peaks 4, 14, and 16. To remove them, simply remove their rows from the peak table. In this case we use the the feature of R that removes elements using a negative subscript:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>edited_peak_df &lt;-<span class="st"> </span>edited_peak_df[<span class="op">-</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">4</span>,<span class="dv">14</span>,<span class="dv">16</span>),]</span></code></pre></div>
<p>Even if you don’t separate groups or delete peaks, it may be helpful to perform a simultaneous fit of all peaks together to remove bias that may have accumulated because of overlap between groups of peaks that were originally fit separately. To do so, you need to convert the peak table back to fit input. That is done with the <code>peak_df_to_fit_input</code> function, which requires the peak table, the set of spectra, and the size of the region of interest around each peak where fitting will be done.</p>
<p>Also, you will need to manually update the lower and upper bounds for parameters, which is done automatically with <code>fit_peak_iter</code>. Here we use <code>update_fit_bounds</code> to constrain omega0 within 1.5 times <code>r2</code> of the starting value, <code>r2</code> to be in the range 0.5-20 Hz, and the scalar coupling to be in the range 2-12 Hz. Finally, we do the fit using the <code>perform_fit</code> function.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>refined_fit_input &lt;-<span class="st"> </span><span class="kw"><a href="../reference/peak_df_to_fit_input.html">peak_df_to_fit_input</a></span>(edited_peak_df, spec_list[<span class="dv">1</span>], <span class="dt">omega0_plus=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.075</span>, <span class="fl">0.75</span>))</span>
<span id="cb17-2"><a href="#cb17-2"></a>refined_fit_input &lt;-<span class="st"> </span><span class="kw"><a href="../reference/update_fit_bounds.html">update_fit_bounds</a></span>(refined_fit_input, <span class="dt">omega0_r2_factor=</span><span class="fl">1.5</span>, <span class="dt">r2_bounds=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>, <span class="dv">20</span>), <span class="dt">sc_bounds=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2</span>, <span class="dv">12</span>))</span>
<span id="cb17-3"><a href="#cb17-3"></a>refined_fit_output &lt;-<span class="st"> </span><span class="kw"><a href="../reference/perform_fit.html">perform_fit</a></span>(refined_fit_input)</span>
<span id="cb17-4"><a href="#cb17-4"></a>refined_peak_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/param_list_to_peak_df.html">param_list_to_peak_df</a></span>(refined_fit_output)</span>
<span id="cb17-5"><a href="#cb17-5"></a>refined_peak_df</span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="co">#&gt;    peak fit omega0_ppm_1 omega0_ppm_2 sc_hz_1 r2_hz_1 r2_hz_2      1.ft2</span></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="co">#&gt; 1     1   1       8.2476       121.87  3.3464  2.8966 2.31700  823653909</span></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="co">#&gt; 2     2   1       8.2596       121.93  3.3464  2.8966 2.31700  239523089</span></span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="co">#&gt; 3     3   2       8.5395       119.76  2.0000  5.7031 2.07497 1120869405</span></span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="co">#&gt; 5     4   3       8.6123       123.37  9.4647  3.2949 2.36755  777520645</span></span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="co">#&gt; 6     5   4       8.5853       123.04  6.0584  6.5825 1.79531  632570914</span></span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="co">#&gt; 7     6   3       8.6439       123.45  9.4647  3.2949 2.36755  163968213</span></span>
<span id="cb17-13"><a href="#cb17-13"></a><span class="co">#&gt; 8     7   4       8.5370       122.96  6.0584  6.5825 1.79531  151176016</span></span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="co">#&gt; 9     8   5       8.3575       119.89 10.1574  1.7355 4.73942  803199446</span></span>
<span id="cb17-15"><a href="#cb17-15"></a><span class="co">#&gt; 10    9   5       8.3749       119.90 10.1574  1.7355 4.73942   96757331</span></span>
<span id="cb17-16"><a href="#cb17-16"></a><span class="co">#&gt; 11   10   6       8.2506       119.41  6.0938  5.0267 1.77681  731298695</span></span>
<span id="cb17-17"><a href="#cb17-17"></a><span class="co">#&gt; 12   11   6       8.2901       119.38  6.0938  5.0267 1.77681  180468792</span></span>
<span id="cb17-18"><a href="#cb17-18"></a><span class="co">#&gt; 13   12   7       8.4819       122.49  9.4013  5.0804 2.41289  587356398</span></span>
<span id="cb17-19"><a href="#cb17-19"></a><span class="co">#&gt; 15   13   7       8.4745       123.01  9.4013  5.0804 2.41289  108282766</span></span>
<span id="cb17-20"><a href="#cb17-20"></a><span class="co">#&gt; 17   14   8       8.4433       120.73  9.1220  4.8622 3.19641  436460816</span></span>
<span id="cb17-21"><a href="#cb17-21"></a><span class="co">#&gt; 18   15   8       8.4244       120.47  9.1220  4.8622 3.19641   95394763</span></span>
<span id="cb17-22"><a href="#cb17-22"></a><span class="co">#&gt; 19   16   8       8.4672       120.52  9.1220  4.8622 3.19641   64410776</span></span>
<span id="cb17-23"><a href="#cb17-23"></a><span class="co">#&gt; 20   17   9       8.3442       120.76  8.3984  1.5895 0.91163   97880231</span></span>
<span id="cb17-24"><a href="#cb17-24"></a><span class="kw"><a href="../reference/plot_peak_df.html">plot_peak_df</a></span>(refined_peak_df, spec_list[<span class="dv">1</span>], <span class="dt">cex=</span><span class="fl">0.6</span>)</span></code></pre></div>
<p><img src="peak2d_files/figure-html/refine-1.png" width="672" style="display: block; margin: auto auto auto 0;"></p>
</div>
</div>
<div id="extending-the-fit-to-other-spectra" class="section level2">
<h2 class="hasAnchor">
<a href="#extending-the-fit-to-other-spectra" class="anchor"></a>Extending the Fit to Other Spectra</h2>
<p>If you have a series of spectra with similar peak shapes, as in this case, you can then extend the fit to more than one spectrum in a manner similar to how we produced the refined peak table above, but instead giving a list of multiple spectra to <code>peak_df_to_fit_input</code>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>extended_fit_input &lt;-<span class="st"> </span><span class="kw"><a href="../reference/peak_df_to_fit_input.html">peak_df_to_fit_input</a></span>(refined_peak_df, spec_list, <span class="dt">omega0_plus=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.075</span>, <span class="fl">0.75</span>))</span></code></pre></div>
<p>We can take a peek at the parameters that show the starting volumes for the refined and extended fits as shown below. Note that the starting volumes for the second spectrum is a second column in the <code>m0</code> matrix. Which has inherited the volumes from the first spectrum. After performing the fit, the second spectrum has much lower volumes.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(refined_fit_output<span class="op">$</span>fit_list<span class="op">$</span>m0)</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="co">#&gt;           [,1]</span></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="co">#&gt; [1,] 411826954</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="co">#&gt; [2,] 411826954</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="co">#&gt; [3,] 119761545</span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="co">#&gt; [4,] 119761545</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="co">#&gt; [5,] 560434702</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="co">#&gt; [6,] 560434702</span></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(extended_fit_input<span class="op">$</span>start_list<span class="op">$</span>m0)</span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="co">#&gt;           [,1]      [,2]</span></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="co">#&gt; [1,] 411826954 411826954</span></span>
<span id="cb19-12"><a href="#cb19-12"></a><span class="co">#&gt; [2,] 411826954 411826954</span></span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="co">#&gt; [3,] 119761545 119761545</span></span>
<span id="cb19-14"><a href="#cb19-14"></a><span class="co">#&gt; [4,] 119761545 119761545</span></span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="co">#&gt; [5,] 560434702 560434702</span></span>
<span id="cb19-16"><a href="#cb19-16"></a><span class="co">#&gt; [6,] 560434702 560434702</span></span>
<span id="cb19-17"><a href="#cb19-17"></a>extended_fit_input &lt;-<span class="st"> </span><span class="kw"><a href="../reference/update_fit_bounds.html">update_fit_bounds</a></span>(extended_fit_input, <span class="dt">omega0_r2_factor=</span><span class="fl">1.5</span>, <span class="dt">r2_bounds=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>, <span class="dv">20</span>), <span class="dt">sc_bounds=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2</span>, <span class="dv">12</span>))</span>
<span id="cb19-18"><a href="#cb19-18"></a>extended_fit_output &lt;-<span class="st"> </span><span class="kw"><a href="../reference/perform_fit.html">perform_fit</a></span>(extended_fit_input)</span>
<span id="cb19-19"><a href="#cb19-19"></a>extended_peak_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/param_list_to_peak_df.html">param_list_to_peak_df</a></span>(extended_fit_output)</span>
<span id="cb19-20"><a href="#cb19-20"></a>extended_peak_df</span>
<span id="cb19-21"><a href="#cb19-21"></a><span class="co">#&gt;    peak fit omega0_ppm_1 omega0_ppm_2 sc_hz_1 r2_hz_1 r2_hz_2      1.ft2     2.ft2</span></span>
<span id="cb19-22"><a href="#cb19-22"></a><span class="co">#&gt; 1     1   1       8.2477       121.87  3.5990  2.8622 2.31689  830842209 210047866</span></span>
<span id="cb19-23"><a href="#cb19-23"></a><span class="co">#&gt; 2     2   1       8.2597       121.93  3.5990  2.8622 2.31689  229341270  95117365</span></span>
<span id="cb19-24"><a href="#cb19-24"></a><span class="co">#&gt; 3     3   2       8.5396       119.76  2.0000  5.7375 2.07965 1123239155 321223317</span></span>
<span id="cb19-25"><a href="#cb19-25"></a><span class="co">#&gt; 5     4   3       8.6124       123.37  9.4971  3.2734 2.36572  776957582 219067212</span></span>
<span id="cb19-26"><a href="#cb19-26"></a><span class="co">#&gt; 6     5   4       8.5854       123.04  5.9568  6.6395 1.78841  634197446 174862251</span></span>
<span id="cb19-27"><a href="#cb19-27"></a><span class="co">#&gt; 7     6   3       8.6441       123.45  9.4971  3.2734 2.36572  162742659  48844731</span></span>
<span id="cb19-28"><a href="#cb19-28"></a><span class="co">#&gt; 8     7   4       8.5370       122.96  5.9568  6.6395 1.78841  151478910  42110074</span></span>
<span id="cb19-29"><a href="#cb19-29"></a><span class="co">#&gt; 9     8   5       8.3576       119.89 10.1415  1.8255 4.77580  811481657 234014667</span></span>
<span id="cb19-30"><a href="#cb19-30"></a><span class="co">#&gt; 10    9   5       8.3747       119.90 10.1415  1.8255 4.77580   90684748  46955496</span></span>
<span id="cb19-31"><a href="#cb19-31"></a><span class="co">#&gt; 11   10   6       8.2507       119.41  6.0253  5.0653 1.80271  733711506 210530936</span></span>
<span id="cb19-32"><a href="#cb19-32"></a><span class="co">#&gt; 12   11   6       8.2902       119.38  6.0253  5.0653 1.80271  180068078  51782211</span></span>
<span id="cb19-33"><a href="#cb19-33"></a><span class="co">#&gt; 13   12   7       8.4820       122.49  9.4837  5.0140 2.39974  585468868 171083375</span></span>
<span id="cb19-34"><a href="#cb19-34"></a><span class="co">#&gt; 15   13   7       8.4746       123.01  9.4837  5.0140 2.39974  107909300  35712860</span></span>
<span id="cb19-35"><a href="#cb19-35"></a><span class="co">#&gt; 17   14   8       8.4434       120.73  9.0403  4.9595 3.20275  438456400 123241978</span></span>
<span id="cb19-36"><a href="#cb19-36"></a><span class="co">#&gt; 18   15   8       8.4246       120.47  9.0403  4.9595 3.20275   96468436  24991594</span></span>
<span id="cb19-37"><a href="#cb19-37"></a><span class="co">#&gt; 19   16   8       8.4672       120.52  9.0403  4.9595 3.20275   63361999  21694761</span></span>
<span id="cb19-38"><a href="#cb19-38"></a><span class="co">#&gt; 20   17   9       8.3444       120.76  8.3617  1.6683 0.87464   98061407  35062473</span></span>
<span id="cb19-39"><a href="#cb19-39"></a><span class="kw"><a href="../reference/plot_peak_df.html">plot_peak_df</a></span>(extended_peak_df, spec_list, <span class="dt">cex=</span><span class="fl">0.6</span>)</span></code></pre></div>
<p>This is the fit for <code>1.ft2</code>.</p>
<p><img src="peak2d_files/figure-html/extend-1.png" width="672"></p>
<p>The fit for <code>2.ft2</code> looks nearly identical but the peaks are about fourfold less intense than <code>1.ft2</code>. You can tell this because the lowest contour level in the plot below is slightly narrower than in the plot above. (Remember that the lowest contour level is drawn at 4x the noise level for all plots drawn by <code>plot_peak_df</code>.)</p>
<p><img src="peak2d_files/figure-html/extend-2.png" width="672"></p>
<p>The peak volumes between the two spectra are highly correlated and have similar relative ratios, indicating that the T<sub>1</sub> values are for the peaks are relatively similar.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>xlim &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="dv">0</span>, extended_peak_df[,<span class="st">"1.ft2"</span>])</span>
<span id="cb20-2"><a href="#cb20-2"></a>ylim &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="dv">0</span>, extended_peak_df[,<span class="st">"2.ft2"</span>])</span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(extended_peak_df[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"1.ft2"</span>, <span class="st">"2.ft2"</span>)], <span class="dt">xlim=</span>xlim, <span class="dt">ylim=</span>ylim)</span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/lsfit.html">lsfit</a></span>(extended_peak_df[,<span class="st">"1.ft2"</span>], extended_peak_df[,<span class="st">"2.ft2"</span>]), <span class="dt">col=</span><span class="st">"red"</span>)</span></code></pre></div>
<p><img src="peak2d_files/figure-html/unnamed-chunk-23-1.png" width="384"></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(extended_peak_df[,<span class="st">"2.ft2"</span>]<span class="op">/</span>extended_peak_df[,<span class="st">"1.ft2"</span>], <span class="dt">xlab=</span><span class="st">"Peak Number"</span>, <span class="dt">ylab=</span><span class="st">"Spectrum 2 Volume/Spectrum 1 Volume"</span>)</span></code></pre></div>
<p><img src="peak2d_files/figure-html/unnamed-chunk-23-2.png" width="384"></p>
</div>
<div id="fitting-peaks-without-coding" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-peaks-without-coding" class="anchor"></a>Fitting Peaks without Coding</h2>
<p>To facilitate the fitting of peaks with minimal amounts of R code, two demo scripts are available that will automatically fit and refit NMRPipe spectra found in the directory you run the scripts from.</p>
<div id="fitting-initial-set-of-peaks" class="section level3">
<h3 class="hasAnchor">
<a href="#fitting-initial-set-of-peaks" class="anchor"></a>Fitting Initial Set of Peaks</h3>
<p>The first, <code>fit_peaks_2d.R</code>, handles the initial fitting of peaks. You would typically use this script to find an initial set of peaks on the highest signal-to-noise spectrum in your dataset. You customize the script by creating a copy of it then editing the parameters at the top of the file prior to running it in R.</p>
<p>In a typical workflow, you would create a directory to perform the initial fitting in, then copy the reference spectrum into that directory. That spectrum must have <code>.ft2</code> as the extension, otherwise the script won’t be able to find it. Ordinarily you would do this manually, but here we will do so in code. The following creates a <code>fit</code> directory and copies the first T<sub>1</sub> spectrum into it.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(<span class="st">"fit"</span>, <span class="dt">showWarnings=</span><span class="ot">FALSE</span>)</span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="kw"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(t1_dir, t1_ft2_filenames[<span class="dv">1</span>]), <span class="st">"fit"</span>)</span></code></pre></div>
<p>Next we need to make a copy of the <code>fit_peaks_2d.R</code> script, which may be easiest to do from within R. (Note: if you want to copy the script into the current working directory, change <code>"fit"</code> to <code>"."</code> in the line below.)</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"demo"</span>, <span class="st">"fit_peaks_2d.R"</span>, <span class="dt">package=</span><span class="st">"fitnmr"</span>), <span class="st">"fit"</span>)</span></code></pre></div>
<p>You can then customize any of the options at the top of <code>fit_peaks_2d</code>:</p>
<pre><code># Fitting Parameters:

# peak height must be at least this times the noise level for a new fitting iteration
noise_cutoff &lt;- 15

# F-test p-value must be less than this value to accept the addition of a new peak
f_alpha &lt;- 0.001

# maximum number of peak fitting iterations to run
iter_max &lt;- 100

# data +/- these ppm values will be used for fitting (1H and X nuclei, respectively)
omega0_plus &lt;- c(0.075, 0.75)

# starting R2 value for the fits
r2_start &lt;- 5

# R2 values are constrained to be between these two numbers
r2_bounds &lt;- c(0.5, 20)

# starting doublet scalar coupling (1H and X nuclei, respectively), NA for singlet
sc_start &lt;- c(6, NA)

# scalar coupling values are constrained to be between these two numbers
sc_bounds &lt;- c(2, 12)


# Plotting Parameters:

# lowest contour in fit_spectra.pdf will be this number times the noise level
plot_noise_cutoff &lt;- 4

# scaling factor for fit_spectra.pdf labels
cex &lt;- 0.4</code></pre>
<p>In this case, we will use the script unmodified. The <code>fit_peaks_2d.R</code> script must be run from within the <code>fit</code> directory, which is done below. (Note: usually you should have already set the working directory to be <code>fit</code> and thus omit the <code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code> calls below.)</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="kw"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">"fit"</span>)</span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"fit_peaks_2d.R"</span>)</span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="co">#&gt; Fit iteration 1:</span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 333.8 (p = 4.56642e-10)</span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 64.6 (p = 1.11899e-05)</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 1.2 (p = 0.464419)</span></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span></span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="co">#&gt; Fit iteration 2:</span></span>
<span id="cb25-9"><a href="#cb25-9"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 734.0 (p = 1.87653e-15)</span></span>
<span id="cb25-10"><a href="#cb25-10"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 14.7 (p = 0.000581712)</span></span>
<span id="cb25-11"><a href="#cb25-11"></a><span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 0.1 (p = 0.976358)</span></span>
<span id="cb25-12"><a href="#cb25-12"></a><span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span></span>
<span id="cb25-13"><a href="#cb25-13"></a><span class="co">#&gt; Fit iteration 3:</span></span>
<span id="cb25-14"><a href="#cb25-14"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 27.7 (p = 7.52698e-13)</span></span>
<span id="cb25-15"><a href="#cb25-15"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 226.0 (p = 2.5923e-27)</span></span>
<span id="cb25-16"><a href="#cb25-16"></a><span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 13.3 (p = 1.34241e-05)</span></span>
<span id="cb25-17"><a href="#cb25-17"></a><span class="co">#&gt;  12 -&gt; 15 fit parameters: F = 68.7 (p = 1.46797e-13)</span></span>
<span id="cb25-18"><a href="#cb25-18"></a><span class="co">#&gt;  15 -&gt; 18 fit parameters: F = 7.0 (p = 0.00144316)</span></span>
<span id="cb25-19"><a href="#cb25-19"></a><span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span></span>
<span id="cb25-20"><a href="#cb25-20"></a><span class="co">#&gt; Fit iteration 4:</span></span>
<span id="cb25-21"><a href="#cb25-21"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 2022.7 (p = 1.60653e-20)</span></span>
<span id="cb25-22"><a href="#cb25-22"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 14.0 (p = 0.000228688)</span></span>
<span id="cb25-23"><a href="#cb25-23"></a><span class="co">#&gt;  Terminating search because fit produced zero volume</span></span>
<span id="cb25-24"><a href="#cb25-24"></a><span class="co">#&gt; Fit iteration 5:</span></span>
<span id="cb25-25"><a href="#cb25-25"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 107.8 (p = 9.74212e-11)</span></span>
<span id="cb25-26"><a href="#cb25-26"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 260.6 (p = 2.04021e-13)</span></span>
<span id="cb25-27"><a href="#cb25-27"></a><span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 11.0 (p = 0.00161564)</span></span>
<span id="cb25-28"><a href="#cb25-28"></a><span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span></span>
<span id="cb25-29"><a href="#cb25-29"></a><span class="co">#&gt; Fit iteration 6:</span></span>
<span id="cb25-30"><a href="#cb25-30"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 1219.7 (p = 6.27674e-21)</span></span>
<span id="cb25-31"><a href="#cb25-31"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 174.9 (p = 1.74543e-15)</span></span>
<span id="cb25-32"><a href="#cb25-32"></a><span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 42.3 (p = 8.00775e-09)</span></span>
<span id="cb25-33"><a href="#cb25-33"></a><span class="co">#&gt;  12 -&gt; 15 fit parameters: F = 11.8 (p = 0.000186865)</span></span>
<span id="cb25-34"><a href="#cb25-34"></a><span class="co">#&gt;  15 -&gt; 18 fit parameters: F = 1.6 (p = 0.223018)</span></span>
<span id="cb25-35"><a href="#cb25-35"></a><span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span></span>
<span id="cb25-36"><a href="#cb25-36"></a><span class="co">#&gt; Fit iteration 7:</span></span>
<span id="cb25-37"><a href="#cb25-37"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 232.0 (p = 1.0692e-22)</span></span>
<span id="cb25-38"><a href="#cb25-38"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 15.9 (p = 1.99824e-06)</span></span>
<span id="cb25-39"><a href="#cb25-39"></a><span class="co">#&gt;   9 -&gt; 12 fit parameters: F = 54.3 (p = 1.15821e-11)</span></span>
<span id="cb25-40"><a href="#cb25-40"></a><span class="co">#&gt;  Terminating search because fit produced zero volume</span></span>
<span id="cb25-41"><a href="#cb25-41"></a><span class="co">#&gt; Fit iteration 8:</span></span>
<span id="cb25-42"><a href="#cb25-42"></a><span class="co">#&gt;   0 -&gt;  6 fit parameters: F = 330.9 (p = 1.75035e-07)</span></span>
<span id="cb25-43"><a href="#cb25-43"></a><span class="co">#&gt;   6 -&gt;  9 fit parameters: F = 1.8 (p = 0.274918)</span></span>
<span id="cb25-44"><a href="#cb25-44"></a><span class="co">#&gt;  Terminating search because F-test p-value &lt; 0.001</span></span>
<span id="cb25-45"><a href="#cb25-45"></a><span class="kw"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">".."</span>)</span></code></pre></div>
<p>This creates a number of files:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="st">"fit"</span>)</span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="co">#&gt; [1] "1.ft2"                "fit_iterations.pdf"   "fit_peaks_2d.R"      </span></span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="co">#&gt; [4] "fit_spectra.pdf"      "fit_volume.csv"       "noise_histograms.pdf"</span></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="co">#&gt; [7] "refit_peaks_2d.R"</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>
<code>noise_histograms.pdf</code> gives a histogram of the noise values for each if the input spectra.</li>
<li>
<code>fit_iterations.pdf</code> shows each iteration of the fitting. The starting peak position (i.e. highest intensity in the spectrum) is indicated with a green circle. The first line of text under each peak gives the peak number and fraction of the total volume in that iteration. The second line gives the F-test p-value for that peak. The title lists the p-value for the peak (not shown) that was rejected because it was greater than <code>f_alpha</code>.</li>
<li>
<code>fit_spectra.pdf</code> shows the overall spectrum as described above.</li>
<li>
<code>fit_volume.csv</code> contains all the identified peaks, along with a column for the volume found in each spectrum.</li>
</ol>
</div>
<div id="refining-the-initial-fit" class="section level3">
<h3 class="hasAnchor">
<a href="#refining-the-initial-fit" class="anchor"></a>Refining the Initial fit</h3>
<p>The initial fit is done iteratively so it is usually a good idea to refine this by editing the fitting groups, deleting extraneous peaks, and then doing a simultaneous refit of all peaks together with the <code>refit_peaks_2d.R</code> script. We will do this in another directory called <code>refine</code>, to which we will also copy the first spectrum and the <code>refit_peaks_2d.R</code> script:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="kw"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(<span class="st">"refine"</span>, <span class="dt">showWarnings=</span><span class="ot">FALSE</span>)</span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="kw"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(t1_dir, t1_ft2_filenames[<span class="dv">1</span>]), <span class="st">"refine"</span>)</span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="kw"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"demo"</span>, <span class="st">"refit_peaks_2d.R"</span>, <span class="dt">package=</span><span class="st">"fitnmr"</span>), <span class="st">"refine"</span>, <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<p>You can then customize any of the options at the top of <code>refit_peaks_2d.R</code>:</p>
<pre><code># Fitting Parameters:

# data +/- these ppm values will be used for fitting (1H and X nuclei, respectively)
omega0_plus &lt;- c(0.075, 0.75)

# omega0 values are constrained to be within this factor times R2 of the starting omega0
omega0_r2_factor &lt;- 1.5

# R2 values are constrained to be between these two numbers
r2_bounds &lt;- c(0.5, 20)

# scalar coupling values are constrained to be between these two numbers
sc_bounds &lt;- c(2, 12)

# enable refitting of omega0
fit_omega0 &lt;- TRUE

# enable refitting of R2
fit_r2 &lt;- TRUE

# enable refitting of scalar couplings
fit_sc &lt;- TRUE


# Plotting Parameters:

# lowest contour in *_fit.pdf will be this number times the noise level
plot_noise_cutoff &lt;- 4

# scaling factor for *_fit.pdf labels
cex &lt;- 0.4

# show omega0 constraints imposed by omega0_r2_factor
plot_omega0_bounds &lt;- TRUE


# Computing Parameters:

# number of cores to use for refitting
mc_cores &lt;- parallel::detectCores()</code></pre>
<p>However, in this case we will use the script unmodified. The next step is to copy the peak list from the previous to a file called <code>start_volume.csv</code> in the new directory:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="kw"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"fit"</span>, <span class="st">"fit_volume.csv"</span>), <span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"refine"</span>, <span class="st">"start_volume.csv"</span>), <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<p>Once that file has been copied, you can then manually change the peak groups, as described above, and delete rows for any peaks you want to discard. In this case, that will be done with the following <code>R</code> code:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>input_table &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"refine"</span>, <span class="st">"start_volume.csv"</span>), <span class="dt">check.names=</span><span class="ot">FALSE</span>)</span>
<span id="cb30-2"><a href="#cb30-2"></a>input_table[<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">5</span>,<span class="dv">7</span>),<span class="st">"fit"</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(input_table[,<span class="st">"fit"</span>])<span class="op">+</span><span class="dv">1</span></span>
<span id="cb30-3"><a href="#cb30-3"></a>input_table &lt;-<span class="st"> </span>input_table[<span class="op">-</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">4</span>,<span class="dv">14</span>,<span class="dv">16</span>),]</span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="kw"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span>(input_table, <span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"refine"</span>, <span class="st">"start_volume.csv"</span>), <span class="dt">row.names=</span><span class="ot">FALSE</span>)</span></code></pre></div>
<p>The final step is to call the <code>refit_peaks_2d.R</code> from within the <code>refine</code> directory:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="kw"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">"refine"</span>)</span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"refit_peaks_2d.R"</span>)</span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="co">#&gt; Fitting m0 for spectrum 1.ft2...</span></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="co">#&gt; Fitting omega0,sc,r2,m0 for spectrum 1.ft2...</span></span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="kw"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">".."</span>)</span></code></pre></div>
<p>The <code>refit_peaks_2d.R</code> script first optimizes the volumes, keeping all other parameters fixed, then optimizes the volumes along with whatever other variables the user specifies in the script. Also, unlike the refinement done in <code>R</code> code above, <code>refit_peaks_2d.R</code> only fits a single spectrum at a time. This avoids two problems:</p>
<ol style="list-style-type: decimal">
<li>For many experiments in which a series of spectra are acquired, different amounts of applied power can result in subtle shifts of the temperature/peak positions. Especially for overlappling peaks, this can cause systematic variations in the volumes. Allowing each spectrum to have slightly different peak positions within a small region around the starting values helps avoid this problem.</li>
<li>When many spectra are fit simultaneously, the memory usage for FitNMR can grow very large. This will hopefully be fixed in a future update.</li>
</ol>
<p>The script creates two files for each spectrum, whose names are derived from the spectrum filenames:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="st">"refine"</span>)</span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="co">#&gt; [1] "1_fit.pdf"        "1_volume.csv"     "1.ft2"            "refit_peaks_2d.R"</span></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="co">#&gt; [5] "start_volume.csv"</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>
<code>1_fit.pdf</code> shows the overall spectrum as described above. In addition, it also shows the constraints on the <code>omega0</code> parameters using gray rectangles, the size of which is determined by the <code>omega0_r2_factor</code> parameter. The central peak position, shown as a small blue dot, is constrained to be within that gray rectangle.</li>
<li>
<code>1_volume.csv</code> contains all the identified peaks, along with a column for the volume found in that spectrum.</li>
</ol>
</div>
<div id="extending-the-fit-to-other-spectra-1" class="section level3">
<h3 class="hasAnchor">
<a href="#extending-the-fit-to-other-spectra-1" class="anchor"></a>Extending the Fit to Other Spectra</h3>
<p>To extend the refined fit to a series of other spectra, we will create another directory called <code>extend</code>. To this directory both T<sub>1</sub> spectra will be copied. In addition, the fit parameters output by the refinement step will be copied to the file <code>start_volume.csv</code> for use as input.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="kw"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(<span class="st">"extend"</span>, <span class="ot">FALSE</span>)</span>
<span id="cb33-2"><a href="#cb33-2"></a><span class="kw"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(t1_dir, t1_ft2_filenames), <span class="st">"extend"</span>)</span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="kw"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"refine"</span>, <span class="st">"1_volume.csv"</span>), <span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"extend"</span>, <span class="st">"start_volume.csv"</span>), <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<p>A copy of the <code>refit_peaks_2d.R</code> script will be used again:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="kw"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"demo"</span>, <span class="st">"refit_peaks_2d.R"</span>, <span class="dt">package=</span><span class="st">"fitnmr"</span>), <span class="st">"extend"</span>, <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</span></code></pre></div>
<p>However, when extending the fit to other spectra, the parameters determining the peak shape (<code>sc</code> and <code>r2</code>) will be fixed, allowing only the volume and peak position to be optimized. This is done by changing <code>fit_sc</code> and <code>fit_r2</code> to <code>FALSE</code> at the top of the script, which can be done using a text editor. For the purposes of this demonstration, the two parameters are changed with the following code:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>script_lines &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"extend"</span>, <span class="st">"refit_peaks_2d.R"</span>))</span>
<span id="cb35-2"><a href="#cb35-2"></a>script_lines &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/grep.html">sub</a></span>(<span class="st">"fit_sc &lt;- TRUE"</span>, <span class="st">"fit_sc &lt;- FALSE"</span>, script_lines)</span>
<span id="cb35-3"><a href="#cb35-3"></a>script_lines &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/grep.html">sub</a></span>(<span class="st">"fit_r2 &lt;- TRUE"</span>, <span class="st">"fit_r2 &lt;- FALSE"</span>, script_lines)</span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="kw"><a href="https://rdrr.io/r/base/writeLines.html">writeLines</a></span>(script_lines, <span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="st">"extend"</span>, <span class="st">"refit_peaks_2d.R"</span>))</span></code></pre></div>
<p>The part of the script showing the parameters to be fit now reads:</p>
<pre><code># enable refitting of omega0
fit_omega0 &lt;- TRUE

# enable refitting of R2
fit_r2 &lt;- FALSE

# enable refitting of scalar couplings
fit_sc &lt;- FALSE</code></pre>
<p>Next, run <code>refit_peaks_2d.R</code> from within the the <code>extend</code> directory. It will do the refitting for each spectrum on a different CPU core, reducing the total time taken to fit a large number of spectra.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="kw"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">"extend"</span>)</span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"refit_peaks_2d.R"</span>)</span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="kw"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span>(<span class="st">".."</span>)</span></code></pre></div>
<p>As above, the script creates two files for each spectrum, whose names are derived from the spectrum filenames:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="st">"extend"</span>)</span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="co">#&gt; [1] "1_fit.pdf"        "1_volume.csv"     "1.ft2"            "2_fit.pdf"       </span></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="co">#&gt; [5] "2_volume.csv"     "2.ft2"            "refit_peaks_2d.R" "start_volume.csv"</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>
<code>*_fit.pdf</code> shows the overall spectrum. Pay particular attention to where the small blue circle is located in the gray rectangle. You may want to adjust <code>omega0_r2_factor</code> to increase or decrease the stringency of the <code>omega0</code> constraint, or possibly choose a different spectrum to use for <code>start_volume.csv</code>.</li>
<li>
<code>*_volume.csv</code> contains all the identified peaks, along with a column for the volume found in that spectrum.</li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#sample-data">Sample Data</a></li>
      <li><a href="#reading-spectra">Reading Spectra</a></li>
      <li><a href="#displaying-spectra">Displaying Spectra</a></li>
      <li><a href="#estimating-noise">Estimating Noise</a></li>
      <li><a href="#fitting-peaks">Fitting Peaks</a></li>
      <li><a href="#fitting-peaks-without-scalar-couplings">Fitting Peaks without Scalar Couplings</a></li>
      <li><a href="#editing-fit-clusters">Editing Fit Clusters</a></li>
      <li><a href="#extending-the-fit-to-other-spectra">Extending the Fit to Other Spectra</a></li>
      <li><a href="#fitting-peaks-without-coding">Fitting Peaks without Coding</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://smithlab.wesleyan.edu">Colin Smith</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
